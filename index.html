<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kibera's Flag Gauntlet</title>
  <style>
    :root{
      --bg: #dfe8f4;
      --ink: #253041;
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);
      --pillBg: rgba(255,255,255,0.10);
      --btnBg: rgba(90,140,255,0.22);
      --btnBgHover: rgba(90,140,255,0.33);

      --flagStageH: 340px; /* fixed stage height so modal never jumps */
      --msgH: 190px;       /* fixed message block height so it never jumps */
      --iconColW: 132px;   /* fixed icon column width */
      --msgColW: 740px;    /* fixed message column width (desktop-ish) */
      --footerH: 33vh;     /* bottom third */
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow-x: hidden;
    }

    /* angled brand */
    .cornerBrand{
      position: fixed;
      left: -40px;
      top: 26px;
      transform: rotate(-45deg);
      transform-origin: left top;
      font-family: "Snell Roundhand", "Brush Script MT", "Apple Chancery", "Comic Sans MS", cursive;
      font-size: 46px;
      color: rgba(37,48,65,0.55);
      letter-spacing: 0.6px;
      z-index: 5;
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
    }

    .main{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 22px;
      padding-bottom: calc(var(--footerH) + 18px); /* keep content above footer */
    }
    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      z-index: 10;
    }

    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      color: #0b1020;
      display:flex;
      align-items:center;
      gap: 10px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .pill b{ font-size: 20px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      font-weight: 700;
      letter-spacing: 0.8px;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
    }

    .titleRow{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 30px;
      letter-spacing: 0.4px;
      font-weight: 300;
      font-family: "Helvetica Neue UltraLight", "HelveticaNeue-UltraLight", "Helvetica Neue", Helvetica, Arial, sans-serif;
      opacity: 0.95;
    }

    /* Fixed-height stage; flags contain within */
    .flagStage{
      height: var(--flagStageH);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 12px;
      box-sizing: border-box;
    }
    .flag{
      width: min(520px, 92%);
      max-height: calc(var(--flagStageH) - 18px);
      object-fit: contain;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }

    /* Controls */
    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 0px;
    }
    .controlRow{
      width: min(520px, 92%);
      display:flex;
      align-items: stretch;
      gap: 10px;
    }
    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
      align-items: stretch;
    }
    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--btnBg);
      color: #e9eefc;
      cursor: pointer;
      min-width: 104px;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.8px;
    }
    button:hover{ background: var(--btnBgHover); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 13px;
      color: rgba(233,238,252,0.70);
      margin-top: -2px;
    }
    .hintHotkeyLine b{ color: rgba(233,238,252,0.92); font-weight: 800; }

    /* Suggestions */
    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{ font-size: 12px; opacity: 0.70; white-space: nowrap; }

    /* Fixed message block: invisible table with fixed icon column + message column */
    .belowMsg{
      width: min(900px, 100%);
      height: var(--msgH);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .msgGrid{
      width: min(900px, 100%);
      display: grid;
      grid-template-columns: var(--iconColW) minmax(0, 1fr);
      align-items: start;            /* TOP align */
      gap: 14px;
      padding: 0 6px;
      box-sizing: border-box;
    }

    .iconWrap{
      width: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .iconSq{
      width: 110px;
      height: 110px;
      border-radius: 18px;
      border: 2px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.55);
      overflow: hidden;
      display: grid;
      place-items: center;
      /* NO SHADOW on icon */
      box-shadow: none;
    }
    .iconSq img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .iconLabel{
      font-size: 10px;
      letter-spacing: 1.1px;
      font-weight: 900;
      color: rgba(37,48,65,0.72);
    }

    .msgText{
      max-width: min(var(--msgColW), 92vw);
      text-align: left;
      line-height: 1.25;
      align-self: start;             /* TOP align */
    }
    .msgText .headline{
      font-size: 18px;
      margin: 0 0 6px;
      min-height: 24px; /* anchor header height so it never jumps */
    }
    .msgText .sub{
      font-size: 14px;
      opacity: 0.88;
      margin: 0;
      min-height: 42px; /* anchor body so it never jumps */
    }

    .spinner{
      display:inline-block;
      width: 12px; height: 12px;
      border: 2px solid rgba(0,0,0,0.20);
      border-top-color: rgba(0,0,0,0.75);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Footer */
    .bottomArea{
      width: 100%;
      position: fixed;
      left: 0;
      bottom: 0;
      height: var(--footerH);
      z-index: 1;
      pointer-events: none;
    }
    .copyright{
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 10px;
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      letter-spacing: 0.3px;
      width: 100%;
    }
    .flagFooter{
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      overflow: hidden;
      background: linear-gradient(to bottom, rgba(223,232,244,0.0), rgba(223,232,244,0.98));
    }
    #footerSvg{
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 0.72;
      mask-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,1.0));
    }

    @media (max-width: 760px){
      :root{ --iconColW: 132px; --msgColW: 520px; }
      .msgText .headline{ font-size: 17px; }
      .pill{ font-size: 16px; }
      .pill b{ font-size: 18px; }
      .cornerBrand{ font-size: 36px; left: -50px; }
    }

    @media (prefers-reduced-motion: reduce){
      .spinner { animation: none; }
    }
  </style>
</head>

<body>
  <div class="cornerBrand">Kibera's Flag Gauntlet</div>

  <div class="main">
    <div class="wrap">
      <div class="topbar">
        <div class="pill" id="statusPill">Loading countriesâ€¦ <span class="spinner" aria-hidden="true"></span></div>

        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>

        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">RESTART</button>
        </div>
      </div>

      <div class="card">
        <div class="titleRow">What Countryâ€™s Flag Is This?</div>

        <div class="flagStage">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country nameâ€¦" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">SUBMIT</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">SKIP</button>
            </div>
          </div>

          <div class="hintHotkeyLine">
            Hit the period <b>&ldquo;.&rdquo;</b> key for a hint! (Hints cost a try.)
          </div>
        </div>
      </div>

      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">Â© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter">
      <svg id="footerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
    </div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  const PAUSE_CORRECT_MS = 5000;
  const PAUSE_WRONG_MS   = 10000;

  // UI
  const statusPill = document.getElementById('statusPill');
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');
  const footerSvg = document.getElementById('footerSvg');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = []; // [{name, continent}]
  let lastRenderedQuery = "";

  // Borders lookup
  let cca3ToCountry = new Map();

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function setStatus(text, withSpinner=false) {
    statusPill.innerHTML = withSpinner
      ? `${text} <span class="spinner" aria-hidden="true"></span>`
      : text;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  // --- Cartoon Icons (always render) ---
  function iconLabelForKind(kind){
    if (kind === 'success') return 'TONY TIGER';
    if (kind === 'fail') return 'FAIL WHALE';
    if (kind === 'hint') return 'HELPFUL HIPPO';
    return '';
  }

  function iconDataURI(kind){
    const svg =
      kind === 'success' ? cartoonTigerSVG() :
      kind === 'fail'    ? cartoonWhaleSVG() :
      kind === 'hint'    ? cartoonHippoSVG() :
                           cartoonStarSVG();
    return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
  }

  function cartoonCardBase(content){
    return `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 110 110">
  <rect x="0" y="0" width="110" height="110" rx="18" fill="#ffffff"/>
  ${content}
</svg>`.trim();
  }

  function cartoonTigerSVG(){
    return cartoonCardBase(`
      <rect x="6" y="6" width="98" height="98" rx="16" fill="#fff7e6"/>
      <circle cx="55" cy="58" r="34" fill="#ffb347" stroke="#101010" stroke-width="3"/>
      <circle cx="28" cy="38" r="12" fill="#ffb347" stroke="#101010" stroke-width="3"/>
      <circle cx="82" cy="38" r="12" fill="#ffb347" stroke="#101010" stroke-width="3"/>
      <circle cx="28" cy="38" r="5" fill="#ffd9a3" stroke="#101010" stroke-width="2"/>
      <circle cx="82" cy="38" r="5" fill="#ffd9a3" stroke="#101010" stroke-width="2"/>

      <ellipse cx="44" cy="58" rx="6" ry="8" fill="#ffffff" stroke="#101010" stroke-width="2"/>
      <ellipse cx="66" cy="58" rx="6" ry="8" fill="#ffffff" stroke="#101010" stroke-width="2"/>
      <circle cx="44" cy="60" r="3" fill="#101010"/>
      <circle cx="66" cy="60" r="3" fill="#101010"/>

      <path d="M55 68c-4 4-8 4-12 0" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <path d="M55 68c4 4 8 4 12 0" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>

      <path d="M50 70l5 6 5-6" fill="#101010"/>
      <path d="M40 46l-10-8M70 46l10-8" stroke="#101010" stroke-width="3" stroke-linecap="round"/>

      <!-- stripes -->
      <path d="M34 54l-10-6M34 64l-10-2M76 54l10-6M76 64l10-2" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <path d="M55 30l0 10" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <path d="M46 32l4 10M64 32l-4 10" stroke="#101010" stroke-width="3" stroke-linecap="round"/>

      <!-- confetti -->
      <circle cx="18" cy="18" r="3" fill="#ff5aa5"/>
      <circle cx="92" cy="20" r="3" fill="#5a8cff"/>
      <circle cx="18" cy="92" r="3" fill="#4bd37b"/>
      <circle cx="92" cy="92" r="3" fill="#ffd34d"/>
    `);
  }

  function cartoonWhaleSVG(){
    return cartoonCardBase(`
      <rect x="6" y="6" width="98" height="98" rx="16" fill="#ecf6ff"/>
      <path d="M18 68c10 10 28 14 44 6 14-7 18-20 32-22-2 12-6 22-14 30-12 12-34 18-52 12-10-4-16-10-18-16 0 0 2-2 8-10z"
            fill="#5a8cff" stroke="#101010" stroke-width="3" stroke-linejoin="round"/>
      <path d="M74 52c8-10 18-14 24-12-2 6-6 10-12 12" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <circle cx="44" cy="66" r="3" fill="#101010"/>
      <path d="M52 72c6 6 12 6 18 0" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <path d="M30 60c-10-10-12-18-10-24 6 2 10 6 12 12" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <path d="M26 34c2-6 6-10 10-12 2 4 2 10-4 16" fill="#9ec7ff" stroke="#101010" stroke-width="3" stroke-linejoin="round"/>
      <path d="M40 30c2-6 6-10 10-12 2 4 2 10-4 16" fill="#9ec7ff" stroke="#101010" stroke-width="3" stroke-linejoin="round"/>
    `);
  }

  function cartoonHippoSVG(){
    return cartoonCardBase(`
      <rect x="6" y="6" width="98" height="98" rx="16" fill="#f0fff6"/>
      <circle cx="55" cy="60" r="34" fill="#9bd6c6" stroke="#101010" stroke-width="3"/>
      <circle cx="30" cy="38" r="12" fill="#9bd6c6" stroke="#101010" stroke-width="3"/>
      <circle cx="80" cy="38" r="12" fill="#9bd6c6" stroke="#101010" stroke-width="3"/>
      <ellipse cx="55" cy="72" rx="22" ry="16" fill="#b9eadc" stroke="#101010" stroke-width="3"/>
      <circle cx="46" cy="74" r="3" fill="#101010"/>
      <circle cx="64" cy="74" r="3" fill="#101010"/>

      <circle cx="44" cy="56" r="4" fill="#101010"/>
      <circle cx="66" cy="56" r="4" fill="#101010"/>

      <path d="M48 62c4 4 10 4 14 0" fill="none" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
      <!-- little idea bulb -->
      <circle cx="86" cy="20" r="8" fill="#ffd34d" stroke="#101010" stroke-width="3"/>
      <path d="M86 28v8" stroke="#101010" stroke-width="3" stroke-linecap="round"/>
    `);
  }

  function cartoonStarSVG(){
    return cartoonCardBase(`
      <rect x="6" y="6" width="98" height="98" rx="16" fill="#ffffff"/>
      <path d="M55 20l8 18 20 2-15 13 5 20-18-10-18 10 5-20-15-13 20-2z"
            fill="#5a8cff" stroke="#101010" stroke-width="3" stroke-linejoin="round"/>
    `);
  }

  function renderMsg(kind, headline, sub){
    const icon = iconDataURI(kind);
    const lab = iconLabelForKind(kind);
    belowMsg.innerHTML = `
      <div class="msgGrid">
        <div class="iconWrap" aria-hidden="true">
          <div class="iconSq"><img src="${icon}" alt="" /></div>
          <div class="iconLabel">${lab}</div>
        </div>
        <div class="msgText">
          <div class="headline">${headline || ""}</div>
          <div class="sub">${sub || ""}</div>
        </div>
      </div>
    `;
  }

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() {
    suggestBox.style.display = 'block';
  }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0;

    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function applySuggestionSelectionToInput() {
    if (suggestBox.style.display !== 'block') return false;
    if (!currentSuggestions.length) return false;

    const idx = Math.max(0, activeSuggestionIndex);
    const pickItem = currentSuggestions[idx] || currentSuggestions[0];
    if (pickItem?.name) {
      guessInput.value = pickItem.name;
      closeSuggest();
      return true;
    }
    return false;
  }

  function renderFlag() {
    closeSuggest();

    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    renderMsg('neutral', '', `Type a country name â€” or hit <b>.</b> for a hint (hint uses a try).`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success', `ğŸ Game complete! Final score: <b>${score}</b>`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      renderMsg('success', `â¡ï¸ Next round!`, `Round <b>${roundIdx + 1}</b> incomingâ€¦`);
      setTimeout(() => renderFlag(), 650);
      updateHUD();
      return;
    }

    renderFlag();
  }

  function acceptedNamesForCountry(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');
    return accepted;
  }

  // --- Better food hints (country-specific when available) ---
  const FOOD_HINT = {
    "Iran": `date palms & saffron rice with meat (<i>Chelo Kabab</i>) ğŸšğŸ¥©`,
    "Peru": `ceviche + lomo saltado (and a million potatoes) ğŸŸğŸ¥”`,
    "Japan": `sushi + ramen (and the art of the bento) ğŸ£ğŸœ`,
    "Italy": `pasta + espresso (and dramatic hand gestures) ğŸâ˜•`,
    "Mexico": `tacos al pastor + mole magic ğŸŒ®ğŸ«`,
    "India": `biryani + masala chai (welcome to spice city) ğŸ›â˜•`,
    "Thailand": `pad thai + green curry ğŸŒ¶ï¸ğŸœ`,
    "Turkey": `kebabs + baklava + strong tea ğŸ¥™ğŸ¯`,
    "Morocco": `tagine + mint tea ğŸ«–ğŸ²`,
    "Ethiopia": `injera + wats (stews) ğŸ²`
  };

  // Famous person (best-known-ish). Extend freely.
  const FAMOUS_PERSON = {
    "Iran": "Famous name: <b>Ayatollah Khomeini</b> (politics) ğŸ§”â€â™‚ï¸",
    "Peru": "Famous name: <b>Mario Vargas Llosa</b> (writer) âœï¸",
    "Turkey": "Famous name: <b>Kemal AtatÃ¼rk</b> (founder) ğŸ‡¹ğŸ‡·",
    "United Kingdom": "Famous name: <b>The Beatles</b> (music) ğŸ¸",
    "France": "Famous name: <b>Napoleon</b> (history) ğŸ§¢",
    "Japan": "Famous name: <b>Hayao Miyazaki</b> (film) ğŸ¬",
    "Brazil": "Famous name: <b>PelÃ©</b> (football) âš½",
    "Mexico": "Famous name: <b>Frida Kahlo</b> (art) ğŸ¨",
    "India": "Famous name: <b>Mahatma Gandhi</b> (history) ğŸ•Šï¸",
    "South Africa": "Famous name: <b>Nelson Mandela</b> (history) âœŠ"
  };

  // 1-line â€œMeaningâ€ from RJTravel pages (curated; add more anytime).
  // Source pages: rjtravelagency.com/flag-of-<country>/
  const FLAG_MEANING_1L = {
    "Peru": "Red symbolizes blood shed for independence; white represents peace and purity (often with the coat of arms on the state flag).",
    "Iran": "Green stands for growth/Islam; white for peace/purity; red for bravery/martyrdom, with a central â€œAllahâ€ emblem.",
    "Kuwait": "Green for growth, white for peace, red for sacrifice, and the black trapezium evokes history/resilience.",
    "Azerbaijan": "Blue for Turkic heritage, red for progress, green for Islam; crescent and eight-pointed star reflect faith and identity."
  };

  function fmtNumber(n){
    if (!Number.isFinite(n)) return 'â€”';
    return n.toLocaleString('en-US');
  }

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Neighbors: <b>none</b> (island / solo mode) ğŸï¸ğŸ˜Œ`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Neighbors: <b>${sample.join(', ')}</b>${extra} ğŸ¤`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles + rice + a signature spice profile ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked goodness ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things + mate vibes ğŸ¥©ğŸŒ½ğŸ§‰",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return `Hint #1: Continent: <b>${cont}</b> ğŸŒ Â· Food: <b>${hint1Food(c)}</b>`;
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] ? `<br/>${FAMOUS_PERSON[c.name.common]}` : '';
      return `Hint #2: Population ~ <b>${pop}</b> ğŸ‘¥${celeb}<br/>${neighborsList(c)}`;
    }
    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Hint #3: Rhymes-ish with: <b>${p.words.join(', ')}</b> ğŸ¶ (I never promised poetry).`;
    }
    return `Hint #3: Ends like â€œ<b>${ends}</b>â€â€¦ try chanting â€œ<b>${ends}!</b>â€ dramatically. ğŸ­`;
  }

  function meaningLineOrFallback(c){
    const name = c.name.common;
    if (FLAG_MEANING_1L[name]) {
      return `<b>Meaning:</b> ${FLAG_MEANING_1L[name]} <span style="opacity:.75">(RJTravel)</span>`;
    }
    return `<b>Meaning:</b> No stored 1-liner for this flag yet â€” anchor it to <b>${continentLabel(c.region, c.subregion)}</b> and build a silly association (works suspiciously well). ğŸ§ âœ¨`;
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Out of tries. Answer: <b>${c.name.common}</b>.`,
        `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      `Hint used (costs a try).`,
      `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    );
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = acceptedNamesForCountry(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const mega = "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰  ğŸ¥³âœ¨ğŸŠ  ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰";
      renderMsg(
        'success',
        `Correct! That was <b>${c.name.common}</b>. ${mega}`,
        `+<b>${pts}</b> point${pts === 1 ? '' : 's'}. Youâ€™re absolutely cooking. ğŸ”¥ğŸŒ<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left. (Hit <b>.</b> for a hint â€” it costs a try.)`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'hint',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    setStatus('Ready');
    renderFlag();
  }

  // Difficulty model
  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }

    // Make Round 1 extra friendly
    const round1 = out[0] || [];
    const round1Names = new Set(round1.map(c => c.name.common));
    const needed = Math.max(0, 8 - round1.filter(c => WELL_KNOWN.has(c.name.common)).length);

    if (needed > 0) {
      const candidates = scored
        .map(x => x.c)
        .filter(c => WELL_KNOWN.has(c.name.common) && !round1Names.has(c.name.common));
      shuffle(candidates);
      for (let i = 0; i < Math.min(needed, candidates.length); i++) {
        round1[FLAGS_PER_ROUND - 1 - i] = candidates[i];
      }
      out[0] = round1;
    }

    return out;
  }

  // --- Footer flags (full width, 3 rows, random offsets + random washed colors, square corners) ---
  function buildFooter() {
    const W = window.innerWidth;
    const H = Math.max(220, Math.floor(window.innerHeight * 0.33));
    footerSvg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    footerSvg.innerHTML = '';

    const ns = "http://www.w3.org/2000/svg";
    const defs = document.createElementNS(ns, 'defs');

    function makeFlagTemplate(id, kind) {
      const g = document.createElementNS(ns, 'g');
      g.setAttribute('id', id);

      const rect = document.createElementNS(ns, 'rect');
      rect.setAttribute('x', '0');
      rect.setAttribute('y', '0');
      rect.setAttribute('width', '44');
      rect.setAttribute('height', '26');
      rect.setAttribute('rx', '0'); // squared
      rect.setAttribute('fill', kind === 'color' ? 'rgba(255,255,255,0.20)' : 'none');
      rect.setAttribute('stroke', 'rgba(37,48,65,0.55)');
      rect.setAttribute('stroke-width', '1.3');
      g.appendChild(rect);

      const mode = id.split('-')[1];

      if (mode === 'jp') {
        const c = document.createElementNS(ns, 'circle');
        c.setAttribute('cx', '22');
        c.setAttribute('cy', '13');
        c.setAttribute('r', '7');
        c.setAttribute('fill', kind === 'color' ? 'rgba(220,70,70,0.35)' : 'none');
        c.setAttribute('stroke', 'rgba(37,48,65,0.40)');
        c.setAttribute('stroke-width', '1.4');
        g.appendChild(c);
      }

      if (mode === 'fr') {
        const a = document.createElementNS(ns, 'rect');
        a.setAttribute('x','0'); a.setAttribute('y','0'); a.setAttribute('width','14.7'); a.setAttribute('height','26');
        a.setAttribute('fill', kind === 'color' ? 'rgba(70,110,200,0.25)' : 'none');
        g.appendChild(a);

        const b = document.createElementNS(ns, 'rect');
        b.setAttribute('x','29.3'); b.setAttribute('y','0'); b.setAttribute('width','14.7'); b.setAttribute('height','26');
        b.setAttribute('fill', kind === 'color' ? 'rgba(220,70,70,0.25)' : 'none');
        g.appendChild(b);

        const s1 = document.createElementNS(ns, 'path');
        s1.setAttribute('d','M15 0V26 M29 0V26');
        s1.setAttribute('stroke','rgba(37,48,65,0.35)');
        s1.setAttribute('stroke-width','1.4');
        g.appendChild(s1);
      }

      if (mode === 'de') {
        const r1 = document.createElementNS(ns,'rect');
        r1.setAttribute('x','0'); r1.setAttribute('y','0'); r1.setAttribute('width','44'); r1.setAttribute('height','8.7');
        r1.setAttribute('fill', kind === 'color' ? 'rgba(20,20,20,0.18)' : 'none');
        g.appendChild(r1);

        const r2 = document.createElementNS(ns,'rect');
        r2.setAttribute('x','0'); r2.setAttribute('y','8.7'); r2.setAttribute('width','44'); r2.setAttribute('height','8.7');
        r2.setAttribute('fill', kind === 'color' ? 'rgba(220,70,70,0.18)' : 'none');
        g.appendChild(r2);

        const r3 = document.createElementNS(ns,'rect');
        r3.setAttribute('x','0'); r3.setAttribute('y','17.4'); r3.setAttribute('width','44'); r3.setAttribute('height','8.7');
        r3.setAttribute('fill', kind === 'color' ? 'rgba(240,200,70,0.18)' : 'none');
        g.appendChild(r3);

        const s = document.createElementNS(ns,'path');
        s.setAttribute('d','M0 9H44 M0 18H44');
        s.setAttribute('stroke','rgba(37,48,65,0.35)');
        s.setAttribute('stroke-width','1.4');
        g.appendChild(s);
      }

      if (mode === 'uk') {
        const s = document.createElementNS(ns,'path');
        s.setAttribute('d','M0 0 L44 26 M44 0 L0 26');
        s.setAttribute('stroke','rgba(37,48,65,0.28)');
        s.setAttribute('stroke-width','1.2');
        g.appendChild(s);

        const c = document.createElementNS(ns,'path');
        c.setAttribute('d','M0 13H44 M22 0V26');
        c.setAttribute('stroke','rgba(37,48,65,0.40)');
        c.setAttribute('stroke-width','1.6');
        g.appendChild(c);
      }

      if (mode === 'us') {
        const stripes = document.createElementNS(ns,'path');
        stripes.setAttribute('d','M0 5H44M0 10H44M0 15H44M0 20H44M0 25H44');
        stripes.setAttribute('stroke','rgba(37,48,65,0.30)');
        stripes.setAttribute('stroke-width','1.2');
        g.appendChild(stripes);

        const canton = document.createElementNS(ns,'rect');
        canton.setAttribute('x','0'); canton.setAttribute('y','0'); canton.setAttribute('width','18'); canton.setAttribute('height','14');
        canton.setAttribute('fill', kind === 'color' ? 'rgba(70,110,200,0.22)' : 'none');
        canton.setAttribute('stroke','rgba(37,48,65,0.30)');
        canton.setAttribute('stroke-width','1.2');
        g.appendChild(canton);
      }

      if (mode === 'br') {
        const d = document.createElementNS(ns,'path');
        d.setAttribute('d','M22 3 L39 13 L22 23 L5 13 Z');
        d.setAttribute('fill','none');
        d.setAttribute('stroke','rgba(37,48,65,0.35)');
        d.setAttribute('stroke-width','1.6');
        g.appendChild(d);

        const c = document.createElementNS(ns,'circle');
        c.setAttribute('cx','22'); c.setAttribute('cy','13'); c.setAttribute('r','5');
        c.setAttribute('fill','none');
        c.setAttribute('stroke','rgba(37,48,65,0.28)');
        c.setAttribute('stroke-width','1.2');
        g.appendChild(c);

        if (kind === 'color') {
          rect.setAttribute('fill','rgba(70,160,100,0.16)');
        }
      }

      return g;
    }

    const templates = [
      { outline: 'o-us', color: 'c-us', mode:'us' },
      { outline: 'o-uk', color: 'c-uk', mode:'uk' },
      { outline: 'o-jp', color: 'c-jp', mode:'jp' },
      { outline: 'o-fr', color: 'c-fr', mode:'fr' },
      { outline: 'o-de', color: 'c-de', mode:'de' },
      { outline: 'o-br', color: 'c-br', mode:'br' }
    ];

    templates.forEach(t => {
      defs.appendChild(makeFlagTemplate(t.outline, 'outline'));
      defs.appendChild(makeFlagTemplate(t.color, 'color'));
    });

    footerSvg.appendChild(defs);

    function use(id, x, y, scale=1){
      const u = document.createElementNS(ns,'use');
      u.setAttribute('href', `#${id}`);
      u.setAttribute('transform', `translate(${x},${y}) scale(${scale})`);
      return u;
    }

    const rows = 3;
    const scale = 0.5;           // 50% smaller
    const flagW = 44 * scale;
    const gap = 26 * scale + 10; // spacing

    const rowYs = [ Math.floor(H*0.30), Math.floor(H*0.54), Math.floor(H*0.78) ];
    const offsets = [
      -Math.floor(Math.random()*160),
      Math.floor(Math.random()*220),
      -Math.floor(Math.random()*260)
    ];

    for (let r = 0; r < rows; r++){
      const group = document.createElementNS(ns,'g');
      group.setAttribute('opacity', String(0.85 - r*0.18));

      const startX = offsets[r];
      const y = rowYs[r];

      const count = Math.ceil((W - startX) / (flagW + gap)) + 2;

      // randomly choose N colored per row
      const coloredTarget = Math.max(3, Math.floor(count * (0.18 + Math.random()*0.10)));
      const coloredSet = new Set();
      while (coloredSet.size < coloredTarget) coloredSet.add(Math.floor(Math.random() * count));

      for (let i = 0; i < count; i++){
        const x = startX + i*(flagW + gap);
        const t = templates[Math.floor(Math.random()*templates.length)];
        const id = coloredSet.has(i) ? t.color : t.outline;
        group.appendChild(use(id, x, y, scale));
      }
      footerSvg.appendChild(group);
    }
  }

  // --- End footer ---
  buildFooter();
  window.addEventListener('resize', () => buildFooter());

  // ---- Hints & Gameplay ----

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Neighbors: <b>none</b> (island / solo mode) ğŸï¸ğŸ˜Œ`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Neighbors: <b>${sample.join(', ')}</b>${extra} ğŸ¤`;
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Out of tries. Answer: <b>${c.name.common}</b>.`,
        `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      `Hint used (costs a try).`,
      `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    );
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return `Hint #1: Continent: <b>${cont}</b> ğŸŒ Â· Food: <b>${hint1Food(c)}</b>`;
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] ? `<br/>${FAMOUS_PERSON[c.name.common]}` : '';
      return `Hint #2: Population ~ <b>${pop}</b> ğŸ‘¥${celeb}<br/>${neighborsList(c)}`;
    }
    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Hint #3: Rhymes-ish with: <b>${p.words.join(', ')}</b> ğŸ¶ (I never promised poetry).`;
    }
    return `Hint #3: Ends like â€œ<b>${ends}</b>â€â€¦ try chanting â€œ<b>${ends}!</b>â€ dramatically. ğŸ­`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles + rice + a signature spice profile ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked goodness ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things + mate vibes ğŸ¥©ğŸŒ½ğŸ§‰",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function meaningLineOrFallback(c){
    const name = c.name.common;
    if (FLAG_MEANING_1L[name]) {
      return `<b>Meaning:</b> ${FLAG_MEANING_1L[name]} <span style="opacity:.75">(RJTravel)</span>`;
    }
    return `<b>Meaning:</b> No stored 1-liner for this flag yet â€” anchor it to <b>${continentLabel(c.region, c.subregion)}</b> and build a silly association (works suspiciously well). ğŸ§ âœ¨`;
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = acceptedNamesForCountry(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const mega = "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰  ğŸ¥³âœ¨ğŸŠ  ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰";
      renderMsg(
        'success',
        `Correct! That was <b>${c.name.common}</b>. ${mega}`,
        `+<b>${pts}</b> point${pts === 1 ? '' : 's'}. LFG. ğŸ”¥ğŸŒ<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left. (Hit <b>.</b> for a hint â€” it costs a try.)`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'hint',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${meaningLineOrFallback(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function renderFlag() {
    closeSuggest();

    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    renderMsg('neutral', '', `Type a country name â€” or hit <b>.</b> for a hint (hint uses a try).`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success', `ğŸ Game complete! Final score: <b>${score}</b>`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      renderMsg('success', `â¡ï¸ Next round!`, `Round <b>${roundIdx + 1}</b> incomingâ€¦`);
      setTimeout(() => renderFlag(), 650);
      updateHUD();
      return;
    }

    renderFlag();
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    setStatus('Ready');
    renderFlag();
  }

  // Wire events
  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', restart);

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => {
    if (guessInput.value) renderSuggestions(guessInput.value);
  });

  // Close suggest when clicking outside
  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  // Keyboard inside input
  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }

    if (e.key === 'Tab') {
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        e.preventDefault();
        applySuggestionSelectionToInput();
      }
      return;
    }

    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        applySuggestionSelectionToInput();
      }
      submitGuess();
      return;
    }
  });

  // Global "." hint (works regardless of focus)
  document.addEventListener('keydown', (e) => {
    if (e.key !== '.') return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;

    const t = e.target;
    const isTextField = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') && !t.readOnly && !t.disabled;
    if (isTextField) e.preventDefault();

    consumeTryWithHint();
    guessInput.focus();
  });

  // Boot
  async function loadCountries() {
    setStatus('Loading countriesâ€¦', true);

    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);

    setStatus('Ready');
    restart();
  }

  loadCountries().catch(err => {
    console.error(err);
    setStatus('Load failed');
    renderMsg('fail', `Couldnâ€™t load country data.`, `${String(err.message || err)}`);
  });
})();
</script>
</body>
</html>
