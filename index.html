<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kibera's Flag Gauntlet</title>

  <style>
    :root{
      --bg: #E1E8F3;
      --ink: #253041;
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);

      --pillBg: rgba(255,255,255,0.10);

      /* Flag module */
      --flagStageH: 340px;

      /* Messaging area */
      --msgH: 320px;
      --iconColW: 170px;

      --brandBlueGrey: rgba(80, 110, 140, 0.42);

      /* Banner heights */
      --bannerH: 190px;
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .flagHeader{
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: var(--bannerH);
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .headerSvg{
      position:absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 1;
      /* Solid at top, fades OUT to bg by the time it reaches the content */
      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,1.00) 0%,
        rgba(0,0,0,1.00) 35%,
        rgba(0,0,0,0.55) 62%,
        rgba(0,0,0,0.00) 100%
      );
    }

    .main{
      flex: 1;
      display: grid;
      place-items: center;
      padding: 70px 14px 10px;
      position: relative;
      z-index: 2;
    }

    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    .brandAngle{
      position: absolute;
      left: -132px;
      top: 118px;
      transform: rotate(-45deg);
      transform-origin: left top;
      font-family: "Calligraffitti", "Snell Roundhand", "Apple Chancery", "Segoe Script", cursive;
      font-size: 46px;
      font-weight: 400;
      color: var(--brandBlueGrey);
      user-select: none;
      pointer-events: none;
      z-index: 10;
      line-height: 0.92;
      text-align: center;
      width: 250px;
    }

    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
      position: relative;
      z-index: 3;
    }

    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      color: #0b1020;
      display:flex;
      align-items:center;
      gap: 10px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .pill b{ font-size: 20px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      letter-spacing: 0.8px;
      font-weight: 900;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
      position: relative;
    }

    .questionTitle{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 34px;
      letter-spacing: 0.3px;
      font-weight: 200;
      opacity: 0.95;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    .flagStage{
      height: var(--flagStageH);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 12px;
      box-sizing: border-box;
    }

    /* Flag size per your spec */
    .flag{
      width: 500px;
      height: 300px;
      object-fit: contain;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      max-width: min(520px, 92%);
      max-height: calc(var(--flagStageH) - 18px);
    }

    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 0px;
    }
    .controlRow{
      width: min(520px, 92%);
      display:flex;
      align-items: stretch;
      gap: 10px;
    }

    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
      align-items: stretch;
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(90,140,255,0.22);
      color: #e9eefc;
      cursor: pointer;
      min-width: 96px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 0.9px;
    }
    button:hover{ background: rgba(90,140,255,0.33); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    /* Only hint CTA below input (and +15% font) */
    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 15px;
      color: rgba(233,238,252,0.78);
      margin-top: -2px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .hintHotkeyLine b{ color: rgba(233,238,252,0.92); font-weight: 600; }

    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{ font-size: 12px; opacity: 0.70; white-space: nowrap; }

    .belowMsg{
      width: min(900px, 100%);
      height: var(--msgH);
      display: grid;
      place-items: center;
      overflow: hidden;
      z-index: 2;
      position: relative;
      margin-top: 0px;
    }

    .msgGrid{
      width: min(900px, 100%);
      display: grid;
      grid-template-columns: var(--iconColW) minmax(0, 1fr);
      align-items: start;
      gap: 18px;
      padding: 0 6px;
      box-sizing: border-box;
    }

    .iconCol{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding-top: 2px;
    }

    .iconSq{
      width: 150px;
      height: 150px;
      border-radius: 0;
      border: none;
      background: transparent;
      overflow: visible;
      display: grid;
      place-items: center;
      box-shadow: none;
    }
    .iconSq svg{
      width: 150px;
      height: 150px;
      display:block;
      overflow: visible;
      background: transparent;
    }

    .msgText{
      text-align: left;
      line-height: 1.25;
      align-self: start;
      padding-top: 6px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
      /* 10% smaller overall */
      transform: scale(0.90);
      transform-origin: left top;
    }
    .msgText .headline{
      font-size: 29px;
      margin: 0 0 10px;
      min-height: 36px;
      color: rgba(37,48,65,0.92);
      font-weight: 320;
    }
    .msgText .sub{
      font-size: 22px;
      opacity: 0.92;
      margin: 0;
      min-height: 96px;
      color: rgba(37,48,65,0.86);
      font-weight: 300;
    }
    /* Bold lighter */
    .msgText b{ font-weight: 520; }
    .msgText a{
      color: rgba(30,80,170,0.95);
      text-decoration: underline;
      font-weight: 520;
    }

    .bottomArea{
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .copyright{
      position: fixed;
      left: 0;
      width: 100%;
      bottom: 50px;
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      letter-spacing: 0.3px;
      z-index: 3;
      pointer-events: none;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }

    .flagFooter{
      position: fixed;
      left: 0;
      width: 100vw;
      bottom: 0;
      top: auto;
      height: 0px; /* JS sets */
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      background: none;
    }
    .footerSvg{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 1;
      /* bottom fade stays correct: transparent near top -> solid towards bottom */
      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0.00) 0%,
        rgba(0,0,0,0.18) 18%,
        rgba(0,0,0,0.55) 40%,
        rgba(0,0,0,1.00) 75%,
        rgba(0,0,0,1.00) 100%
      );
    }

    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    .roundOverlay{
      position: fixed;
      inset: 0;
      display: none;
      pointer-events: none;
      z-index: 10000;
      place-items: center;
      text-align: center;
    }
    .roundOverlay .big{
      font-family: "Impact", "Haettenschweiler", "Arial Black", sans-serif;
      font-weight: 900;
      font-size: min(140px, 16vw);
      line-height: 0.95;
      color: rgba(0,0,0,0.88);
      padding: 0;
      border-radius: 0;
      background: transparent;
      border: none;
    }

    @media (max-width: 900px){
      .brandAngle{ left: -122px; top: 130px; font-size: 40px; width: 230px; }
      .questionTitle{ font-size: 30px; }
      :root{ --iconColW: 170px; --msgH: 300px; }
    }
    @media (max-width: 760px){
      :root{ --iconColW: 160px; --msgH: 290px; }
      .pill{ font-size: 16px; }
      .pill b{ font-size: 18px; }
      .questionTitle{ font-size: 26px; }
      .brandAngle{ font-size: 34px; left: -110px; top: 140px; width: 210px; }
      .iconSq{ width: 140px; height: 140px; }
      .iconSq svg{ width: 140px; height: 140px; }
    }
  </style>
</head>

<body>
  <!-- Header banner -->
  <div class="flagHeader" aria-hidden="true">
    <svg id="headerSvg" class="headerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
  </div>

  <div class="confettiLayer" id="confettiLayer">
    <canvas id="confettiCanvas" style="width:100%;height:100%"></canvas>
  </div>

  <div class="roundOverlay" id="roundOverlay">
    <div class="big" id="roundOverlayText"></div>
  </div>

  <div class="main">
    <div class="wrap">
      <div class="brandAngle">Kibera's<br/>Flag Gauntlet</div>

      <div class="topbar">
        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>
        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">RESTART</button>
        </div>
      </div>

      <div class="card" id="card">
        <div class="questionTitle">What Country's Flag Is This?</div>

        <div class="flagStage">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country nameâ€¦" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">SUBMIT</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">SKIP</button>
            </div>
          </div>

          <div class="hintHotkeyLine">
            Hit the period <b>&ldquo;.&rdquo;</b> key for a hint! Each hint costs a try
          </div>
        </div>
      </div>

      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">Â© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter" aria-hidden="true">
      <svg id="footerSvg" class="footerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
    </div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  const PAUSE_CORRECT_MS = 3000;
  const PAUSE_WRONG_MS   = 10000;

  // UI
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');

  const headerSvg = document.getElementById('headerSvg');
  const footerSvg = document.getElementById('footerSvg');

  const confettiLayer = document.getElementById('confettiLayer');
  const confettiCanvas = document.getElementById('confettiCanvas');
  const roundOverlay = document.getElementById('roundOverlay');
  const roundOverlayText = document.getElementById('roundOverlayText');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = [];
  let lastRenderedQuery = "";

  let cca3ToCountry = new Map();

  // Banner cache (so header/footer are identical mirrors)
  let bannerLayout = null;

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  // ------------------------------------------------------------------------------------
  // COMIC BURST ICONS â€” transparent outside the burst (no background blocks)
  // ------------------------------------------------------------------------------------
  function burstIconSVG(kind, text){
    // Important: no rect background; only burst + halftone + text.
    const outline = "rgba(0,0,0,0.88)";
    const textStrokeW = 5.0;  // slightly thinner than before per request
    const burstStrokeW = 6.0;

    // Shape closely matching the â€œROLL!â€ style burst
    const burstD = "M55 6 L64 20 L82 10 L79 30 L98 26 L86 42 L104 50 L86 56 L98 74 L79 70 L82 90 L64 80 L55 104 L46 80 L28 90 L31 70 L12 74 L24 56 L6 50 L24 42 L12 26 L31 30 L28 10 L46 20 Z";

    // Color schemes
    let outer = "#ff3b30";
    let inner = "#ffd60a";
    let wordFill = "#38d66b";

    if (kind === "default") { // LET'S GO!
      outer = "#0f7a2e";
      inner = "#b8f06a";
      wordFill = "#38d66b";
    }
    if (kind === "fail") { // OH NAWR!
      outer = "#ff3b30";
      inner = "#ffd60a";
      wordFill = "#ffd60a";
    }
    if (kind === "success") { // BOOM!
      outer = "#ff3b30";
      inner = "#ffd60a";
      wordFill = "#9ad0ff";
    }
    if (kind === "hint") { // PSSSST!
      outer = "#2b6cff";
      inner = "#a7c8ff";
      wordFill = "#9ad0ff";
    }

    return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <radialGradient id="g-${kind}" cx="48%" cy="45%" r="70%">
            <stop offset="0%" stop-color="${inner}"/>
            <stop offset="100%" stop-color="${outer}"/>
          </radialGradient>
          <pattern id="dots-${kind}" width="10" height="10" patternUnits="userSpaceOnUse">
            <circle cx="2" cy="2" r="1.6" fill="rgba(0,0,0,0.22)"/>
          </pattern>
          <filter id="soft-${kind}">
            <feDropShadow dx="0" dy="2" stdDeviation="1.2" flood-color="rgba(0,0,0,0.22)"/>
          </filter>
        </defs>

        <!-- burst -->
        <path d="${burstD}" fill="url(#g-${kind})" stroke="${outline}" stroke-width="${burstStrokeW}" stroke-linejoin="round" filter="url(#soft-${kind})"/>
        <!-- halftone on burst only -->
        <path d="${burstD}" fill="url(#dots-${kind})" opacity="0.55"/>

        <!-- action lines (no background) -->
        <g stroke="${outline}" stroke-width="4" stroke-linecap="round" opacity="0.9">
          <line x1="12" y1="18" x2="0" y2="6"/>
          <line x1="20" y1="10" x2="14" y2="0"/>
          <line x1="94" y1="18" x2="110" y2="6"/>
          <line x1="90" y1="10" x2="96" y2="0"/>
          <line x1="12" y1="86" x2="0" y2="104"/>
          <line x1="94" y1="86" x2="110" y2="104"/>
        </g>

        <!-- text -->
        <g transform="translate(55 62) rotate(-7)">
          <text text-anchor="middle"
                font-family="Impact, Haettenschweiler, 'Arial Black', sans-serif"
                font-size="${text.length >= 7 ? 30 : 34}"
                font-weight="900"
                fill="${wordFill}"
                stroke="${outline}"
                stroke-width="${textStrokeW}"
                paint-order="stroke fill">
            ${text}
          </text>
        </g>
      </svg>
    `;
  }

  function renderMsg(kind, headline, sub){
    let label = "LET'S GO!";
    let k = "default";
    if (kind === "fail") { label = "OH NAWR!"; k = "fail"; }
    if (kind === "success") { label = "BOOM!"; k = "success"; }
    if (kind === "hint") { label = "PSSSST!"; k = "hint"; }

    belowMsg.innerHTML = `
      <div class="msgGrid">
        <div class="iconCol">
          <div class="iconSq">${burstIconSVG(k, label)}</div>
        </div>
        <div class="msgText">
          <div class="headline">${headline || ""}</div>
          <div class="sub">${sub || ""}</div>
        </div>
      </div>
    `;
  }

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() { suggestBox.style.display = 'block'; }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0;

    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function applySuggestionSelectionToInput() {
    if (suggestBox.style.display !== 'block') return false;
    if (!currentSuggestions.length) return false;

    const idx = Math.max(0, activeSuggestionIndex);
    const pickItem = currentSuggestions[idx] || currentSuggestions[0];
    if (pickItem?.name) {
      guessInput.value = pickItem.name;
      closeSuggest();
      return true;
    }
    return false;
  }

  function currentAcceptedNames(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');
    return accepted;
  }

  function fmtNumber(n){
    if (!Number.isFinite(n)) return 'â€”';
    return n.toLocaleString('en-US');
  }

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Â· <b>Neighbors</b>: <b>none</b> (island / solo mode) ğŸï¸`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Â· <b>Neighbors</b>: ${sample.join(', ')}${extra} ğŸ¤`;
  }

  const FOOD_HINT = {
    "Iran": `date palms & saffron rice with meat (Chelo Kabab) ğŸšğŸ¥©`,
    "Peru": `ceviche + lomo saltado ğŸŸğŸ¥”`,
    "Japan": `sushi + ramen ğŸ£ğŸœ`,
    "Italy": `pasta + espresso ğŸâ˜•`,
    "Mexico": `tacos al pastor + mole ğŸŒ®ğŸ«`,
    "India": `biryani + masala chai ğŸ›â˜•`,
    "Thailand": `pad thai + green curry ğŸŒ¶ï¸ğŸœ`,
    "Turkey": `kebabs + baklava ğŸ¥™ğŸ¯`,
    "Morocco": `tagine + mint tea ğŸ«–ğŸ²`,
    "Ethiopia": `injera + wats ğŸ²`,
    "France": `croissant + cheese ğŸ¥ğŸ§€`,
    "United States": `burgers + BBQ ğŸ”ğŸ”¥`,
    "Australia": `flat white + meat pie + â€œbarbieâ€ culture â˜•ğŸ¥§`
  };

  const FAMOUS_PERSON = {
    "Australia": "Chris Hemsworth (actor) ğŸ¬",
    "New Zealand": "Taika Waititi (filmmaker) ğŸ¬",
    "United States": "BeyoncÃ© (musician) ğŸ¤",
    "Canada": "Ryan Reynolds (actor) ğŸ¬",
    "United Kingdom": "David Bowie (musician) ğŸ¸",
    "France": "Marie Curie (scientist) âš—ï¸",
    "Germany": "Albert Einstein (scientist) ğŸ§ ",
    "Japan": "Hayao Miyazaki (filmmaker) ğŸ¬",
    "India": "Mahatma Gandhi (leader) ğŸ•Šï¸",
    "Brazil": "PelÃ© (athlete) âš½",
    "Mexico": "Frida Kahlo (artist) ğŸ¨",
    "Peru": "Mario Vargas Llosa (writer) ğŸ“š"
  };

  const SYMBOLISM_ONE_LINER = {
    "Peru": "Red honors sacrifice in the independence struggle; white stands for peace/purity.",
    "Iran": "Green/white/red are tied to growth/peace/courage; emblem/pattern reference Islamic identity.",
    "Japan": "Red sun disc represents the sunâ€”Japan as the â€˜land of the rising sun.â€™",
    "France": "Tricolor tied to the Revolution; often read as liberty/equality/fraternity."
  };

  function rjSlugForCountry(name){
    const slug = name.toLowerCase()
      .replace(/â€™/g,'')
      .replace(/'/g,'')
      .replace(/&/g,'and')
      .replace(/[^a-z0-9 ]/g,'')
      .trim()
      .replace(/\s+/g, '-');
    return `https://www.rjtravelagency.com/flag-of-${slug}/`;
  }

  function symbolismBlock(c){
    const name = c.name.common;
    const one = SYMBOLISM_ONE_LINER[name];
    const url = rjSlugForCountry(name);
    return one
      ? `<b>Flag meaning</b>: ${one}`
      : `â„¹ï¸ <a href="${url}" target="_blank" rel="noopener">Learn more about this flag</a>`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles/rice + a signature spice combo ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked magic ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things ğŸ¥©ğŸŒ½",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return [
        `Â· <b>Continent</b>: ${cont} ğŸŒ`,
        `Â· <b>Food</b>: ${hint1Food(c)}`
      ].join('<br/>');
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] || `A person too powerful for this hint engine ğŸ•¶ï¸`;
      return [
        `Â· <b>Famous Name</b>: ${celeb}`,
        `Â· <b>Population</b>: ${pop} ğŸ‘¥`,
        neighborsList(c)
      ].join('<br/>');
    }

    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Â· <b>Rhymes-ish</b>: ${p.words.join(', ')} ğŸ¶`;
    }
    return `Â· <b>Sound clue</b>: ends like â€œ${ends}â€â€¦ try yelling â€œ${ends}!â€ dramatically ğŸ­`;
  }

  function renderFlag() {
    closeSuggest();
    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    renderMsg('default', '', `Type a country name.`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  // Confetti: more volume, 3s
  function confettiBurst(ms=3000){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);

    confettiCanvas.width = w;
    confettiCanvas.height = h;

    const ctx = confettiCanvas.getContext('2d');
    const pieces = [];
    const colors = ['#ff6b6b','#ffd93d','#6bcBef','#6bff95','#b36bff','#ff9f43'];

    const count = 520;
    for (let i=0;i<count;i++){
      pieces.push({
        x: Math.random()*w,
        y: -60 - Math.random()*h*0.35,
        vx: (Math.random()*2-1) * dpr * 2.0,
        vy: (Math.random()*1+1.2) * dpr * 2.2,
        r: (Math.random()*4+3) * dpr,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*0.18-0.09),
        c: colors[Math.floor(Math.random()*colors.length)],
        life: Math.random()*0.7 + 0.3
      });
    }

    confettiLayer.style.display = 'block';

    const start = performance.now();
    function tick(t){
      const p = Math.min(1, (t-start)/ms);
      ctx.clearRect(0,0,w,h);

      const fade = Math.max(0, 1 - p);

      for (const s of pieces){
        s.x += s.vx;
        s.y += s.vy;
        s.rot += s.vr;
        s.vy += 0.020 * dpr;
        s.vx *= 0.994;
        s.vy *= 0.997;

        const alpha = Math.max(0, fade * s.life);

        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = s.c;
        ctx.fillRect(-s.r, -s.r, s.r*2.2, s.r*1.2);
        ctx.restore();
      }

      if (p < 1) requestAnimationFrame(tick);
      else confettiLayer.style.display = 'none';
    }
    requestAnimationFrame(tick);
  }

  // Round overlay: comic burst zoom from vanishing point
  function roundTransition(nextRoundNumber){
    roundOverlayText.textContent = `ROUND ${nextRoundNumber}!`;
    roundOverlay.style.display = 'grid';

    roundOverlayText.style.transform = 'scale(0.05)';
    roundOverlayText.style.opacity = '0.0';
    roundOverlayText.style.transition = 'transform 700ms cubic-bezier(.2,.9,.2,1), opacity 350ms ease';

    requestAnimationFrame(() => {
      roundOverlayText.style.opacity = '1.0';
      roundOverlayText.style.transform = 'scale(1.0)';
    });

    confettiBurst(3000);

    setTimeout(() => {
      roundOverlay.style.display = 'none';
      renderFlag();
    }, 2400);
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success', `ğŸ Game complete! Final score: <b>${score}</b> ğŸ‰`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      updateHUD();
      roundTransition(roundIdx + 1);
      return;
    }

    renderFlag();
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Out of tries! Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      `Hint used (costs a try!)`,
      `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    );
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = currentAcceptedNames(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const emoji = pick(["ğŸ‰","ğŸ¥³","âœ¨"]);
      renderMsg(
        'success',
        `Correct! That was <b>${c.name.common}</b>. ${emoji}`,
        `You earned <b>${pts}</b> point${pts === 1 ? '' : 's'}.<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left. (Hit <b>.</b> for a hint â€” it costs a try.)`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'default',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    renderFlag();
  }

  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }
    return out;
  }

  // ------------------------------------------------------------------------------------
  // HEADER/FOOTER FLAGS â€” add detail back using real country flag SVGs,
  // and color only ~10% (rest are grey â€œoutline-ishâ€ via filter).
  // Layout is mirrored: header is an inverted mirror of footer with identical proportions.
  // ------------------------------------------------------------------------------------
  function seededRng(seed){
    let t = seed >>> 0;
    return function(){
      t += 0x6D2B79F5;
      let x = Math.imul(t ^ (t >>> 15), 1 | t);
      x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
      return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
    };
  }

  function computeBannerLayout(w, h, seed){
    const rand = seededRng(seed);

    const padX = 16;
    const padY = 12;

    const flagW = 44;
    const flagH = 26;

    // Slightly larger row spacing + more jitter so it looks scattered, not columns
    const cellW = flagW * 1.20;
    const cellH = flagH * 1.34;

    const cols = Math.max(10, Math.floor((w - padX*2) / cellW));
    const rows = Math.max(5, Math.floor((h - padY*2) / cellH));

    const pts = [];
    for (let r = 0; r < rows; r++){
      for (let c = 0; c < cols; c++){
        const xBase = padX + c * cellW;
        const yBase = padY + r * cellH;

        const jx = (rand()*2 - 1) * (cellW * 0.60);
        const jy = (rand()*2 - 1) * (cellH * 0.75);

        pts.push({ x: xBase + jx, y: yBase + jy });
      }
    }
    pts.sort((a,b)=> a.y - b.y);

    // Keep a "mountain" bias: footer uses lower portion; header mirrors it.
    const keepStart = Math.floor(pts.length * 0.20);
    const keep = pts.slice(keepStart);

    // Light extra density near bottom
    const extra = [];
    for (let i = Math.floor(keep.length*0.70); i < keep.length; i += 4){
      const p = keep[i];
      extra.push({ x: p.x + (rand()*8-4), y: p.y + (rand()*8-4) });
    }

    const all = keep.concat(extra);

    // Select 10% to be colored
    const coloredCount = Math.max(1, Math.floor(all.length * 0.10));
    const coloredIdx = new Set();
    while (coloredIdx.size < coloredCount) coloredIdx.add(Math.floor(rand() * all.length));

    return { all, coloredIdx, flagW, flagH };
  }

  function buildFlagBanners(){
    const footerEl = document.querySelector('.flagFooter');
    const msgRect = belowMsg.getBoundingClientRect();
    const pad = 10;

    // footer starts after message box
    const topPx = Math.min(
      Math.max(msgRect.bottom + pad, window.innerHeight * 0.64),
      window.innerHeight - 120
    );

    footerEl.style.top = `${Math.round(topPx)}px`;
    footerEl.style.height = `${Math.max(0, Math.round(window.innerHeight - topPx))}px`;

    // banner SVG sizing
    const w = Math.max(1400, window.innerWidth);

    const headerH = Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bannerH')) || 190);
    const footerH = Math.max(220, Math.round(window.innerHeight - topPx));

    headerSvg.setAttribute('viewBox', `0 0 ${w} ${headerH}`);
    footerSvg.setAttribute('viewBox', `0 0 ${w} ${footerH}`);

    headerSvg.innerHTML = '';
    footerSvg.innerHTML = '';

    // choose a pool of flags (use real flag SVGs for detail)
    const pool = countries.filter(c => c.flags && (c.flags.svg || c.flags.png));
    if (!pool.length) return;

    // layout cached so header/footer are identical mirrors
    if (!bannerLayout || bannerLayout.w !== w || bannerLayout.headerH !== headerH || bannerLayout.footerH !== footerH) {
      // One layout computed off the footer height, then mirrored to header
      const base = computeBannerLayout(w, footerH, 1337);
      bannerLayout = { w, headerH, footerH, ...base };
    }

    const NS = 'http://www.w3.org/2000/svg';

    function defsFor(svg){
      const defs = document.createElementNS(NS,'defs');

      // Grey â€œoutline-ishâ€ filter: desaturate + lift whites + soften color
      const f = document.createElementNS(NS,'filter');
      f.setAttribute('id','greyOutline');
      f.innerHTML = `
        <feColorMatrix type="matrix"
          values="
            0.25 0.25 0.25 0 0
            0.25 0.25 0.25 0 0
            0.25 0.25 0.25 0 0
            0    0    0    1 0"/>
        <feComponentTransfer>
          <feFuncR type="gamma" amplitude="1" exponent="0.85" offset="0.06"/>
          <feFuncG type="gamma" amplitude="1" exponent="0.85" offset="0.06"/>
          <feFuncB type="gamma" amplitude="1" exponent="0.85" offset="0.06"/>
        </feComponentTransfer>
      `;
      defs.appendChild(f);

      svg.appendChild(defs);
    }

    defsFor(headerSvg);
    defsFor(footerSvg);

    const { all, coloredIdx, flagW, flagH } = bannerLayout;

    // Helper to append one image flag
    function addFlag(svg, x, y, isColored, idx){
      const c = pool[idx % pool.length];
      const href = c.flags.svg || c.flags.png;
      const img = document.createElementNS(NS, 'image');
      img.setAttribute('href', href);
      img.setAttribute('x', x);
      img.setAttribute('y', y);
      img.setAttribute('width', flagW);
      img.setAttribute('height', flagH);
      img.setAttribute('preserveAspectRatio','xMidYMid meet');

      if (!isColored){
        img.setAttribute('filter','url(#greyOutline)');
        img.setAttribute('opacity','0.70');
      } else {
        // Slightly faded but recognizable
        img.setAttribute('opacity','0.86');
      }
      svg.appendChild(img);
    }

    // Deterministic order for â€œsame flags top & bottomâ€
    const orderRand = seededRng(424242);
    const order = all.map((_, i) => i);
    for (let i = order.length - 1; i > 0; i--) {
      const j = Math.floor(orderRand() * (i + 1));
      [order[i], order[j]] = [order[j], order[i]];
    }

    // Footer: draw top->bottom for occlusion
    const footerItems = all.map((p, i) => ({
      i,
      x: p.x,
      y: p.y,
      colored: coloredIdx.has(i)
    })).sort((a,b)=> a.y - b.y);

    // Header: exact mirror vertically, identical proportions
    const headerItems = footerItems.map(it => ({
      i: it.i,
      x: it.x,
      y: Math.max(0, bannerLayout.headerH - it.y - flagH),
      colored: it.colored
    })).sort((a,b)=> a.y - b.y);

    // Draw
    footerItems.forEach((it, k) => addFlag(footerSvg, it.x, it.y, it.colored, order[k]));
    headerItems.forEach((it, k) => addFlag(headerSvg, it.x, it.y, it.colored, order[k]));
  }

  // Events
  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', () => { restart(); buildFlagBanners(); });

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => { if (guessInput.value) renderSuggestions(guessInput.value); });

  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }
    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        applySuggestionSelectionToInput();
      }
      submitGuess();
      return;
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== '.') return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;
    const t = e.target;
    const isTextField = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') && !t.readOnly && !t.disabled;
    if (isTextField) e.preventDefault();
    consumeTryWithHint();
    guessInput.focus();
  });

  // Boot
  async function loadCountries() {
    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);

    // Build banners (adds detail + 10% true color)
    buildFlagBanners();

    restart();
  }

  loadCountries().catch(err => {
    console.error(err);
    renderMsg('fail', `Couldnâ€™t load country data.`, `${String(err.message || err)}`);
  });

  window.addEventListener('resize', () => buildFlagBanners());
})();
</script>
</body>
</html>
