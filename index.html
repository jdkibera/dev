<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kibera's Flag Gauntlet</title>
  <style>
    :root{
      --bg: #dfe8f4;            /* light bluish grey */
      --ink: #253041;           /* dark grey text on light bg */
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);
      --pillBg: rgba(255,255,255,0.10);
      --pillBorder: rgba(255,255,255,0.14);
      --btnBg: rgba(90,140,255,0.22);
      --btnBgHover: rgba(90,140,255,0.33);
      --muted: rgba(233,238,252,0.72);
    }

    /* Page layout */
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Centered main content */
    .main{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 22px;
    }
    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    /* Top HUD */
    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 16px;              /* MUCH larger header font */
      color: #0b1020;
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .pill b{ font-size: 18px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    /* Dark modal */
    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
    }

    /* Ultra-thin, larger title */
    .titleRow{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 34px;
      letter-spacing: 0.6px;
      font-weight: 200;
      font-family: "Helvetica Neue UltraLight", "HelveticaNeue-UltraLight", "Helvetica Neue", Helvetica, Arial, sans-serif;
      opacity: 0.95;
    }

    .flagBox{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 280px;
      padding: 10px 0 14px;
    }
    .flag{
      max-width: 520px;
      width: min(520px, 92%);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
    }

    /* Controls: input + buttons aligned to right of input */
    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    .controlRow{
      width: min(520px, 92%);  /* match flag width */
      display:flex;
      align-items: stretch;
      gap: 10px;
    }
    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
    }
    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--btnBg);
      color: #e9eefc;
      cursor: pointer;
      min-width: 96px;
      font-size: 14px;
    }
    button:hover{ background: var(--btnBgHover); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 13px;
      color: rgba(233,238,252,0.70);
      margin-top: -2px;
    }
    .hintHotkeyLine b{
      color: rgba(233,238,252,0.92);
      font-weight: 600;
    }

    /* Suggest dropdown: prefix-only, continent annotation on the right */
    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{
      font-size: 12px;
      opacity: 0.70;
      white-space: nowrap;
    }

    /* (Hidden) in-modal message boxes removed; messaging goes below modal */
    .screen{ display:none; }

    /* Below-modal messaging on light background */
    .belowMsg{
      width: min(900px, 100%);
      text-align: center;
      color: var(--ink);
      margin-top: 2px;
      min-height: 86px; /* holds multi-line fail/success without layout jump */
    }
    .belowMsg .line{
      font-size: 16px;
      margin: 6px 0;
    }
    .belowMsg .sub{
      font-size: 14px;
      opacity: 0.85;
      margin: 6px 0;
    }
    .belowMsg pre{
      margin: 10px auto 0;
      text-align: left;
      display: inline-block;
      color: rgba(37,48,65,0.95);
      background: rgba(0,0,0,0.02);
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      white-space: pre-wrap;
      max-width: min(900px, 96%);
      overflow: auto;
    }

    .spinner{
      display:inline-block;
      width: 12px; height: 12px;
      border: 2px solid rgba(0,0,0,0.20);
      border-top-color: rgba(0,0,0,0.75);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Bottom footer (1-inch-ish) with stylized flag outlines */
    .bottomArea{
      position: relative;
      width: 100%;
    }
    .copyright{
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      margin: 6px 0 8px;
      letter-spacing: 0.3px;
    }
    .flagFooter{
      height: 96px; /* ~1 inch at typical CSS pixel density */
      width: 100%;
      position: relative;
      overflow: hidden;
      background: linear-gradient(to bottom, rgba(223,232,244,0.0), rgba(223,232,244,0.95));
    }
    .flagFooter::before{
      content: "";
      position: absolute;
      inset: -40px -80px -10px -80px;
      opacity: 0.55;
      /* a ‚Äúfield‚Äù of outlined flags using repeating gradients */
      background:
        repeating-linear-gradient(90deg,
          rgba(37,48,65,0.00) 0px,
          rgba(37,48,65,0.00) 26px,
          rgba(37,48,65,0.35) 26px,
          rgba(37,48,65,0.35) 28px,
          rgba(37,48,65,0.00) 28px,
          rgba(37,48,65,0.00) 64px),
        repeating-linear-gradient(0deg,
          rgba(37,48,65,0.00) 0px,
          rgba(37,48,65,0.00) 18px,
          rgba(37,48,65,0.25) 18px,
          rgba(37,48,65,0.25) 20px,
          rgba(37,48,65,0.00) 20px,
          rgba(37,48,65,0.00) 52px);
      filter: blur(0.2px);
      transform: rotate(-2deg);
      mask-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,1.0));
    }

    /* Accessibility: reduced motion */
    @media (prefers-reduced-motion: reduce){
      .spinner { animation: none; }
    }
  </style>
</head>

<body>
  <div class="main">
    <div class="wrap">
      <div class="topbar">
        <div class="pill" id="statusPill">Loading countries‚Ä¶ <span class="spinner" aria-hidden="true"></span></div>

        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>
        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">Restart</button>
        </div>
      </div>

      <div class="card">
        <div class="titleRow">Kibera's Flag Gauntlet</div>

        <div class="flagBox">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country name‚Ä¶" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">Submit</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">Skip</button>
            </div>
          </div>

          <div class="hintHotkeyLine">Hit the period <b>&ldquo;.&rdquo;</b> key for a hint!</div>
        </div>
      </div>

      <!-- Messaging BELOW the modal, centered, no box -->
      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">¬© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter" aria-hidden="true"></div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  // UI
  const statusPill = document.getElementById('statusPill');
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = []; // [{name, continent}]
  let lastRenderedQuery = "";

  // Map for neighbor lookup
  let cca3ToCountry = new Map(); // cca3 -> country object (our shape)

  // Detailed ASCII Fail Whale
  const FAIL_WHALE = `
                 _.-'''''-._
             _.-'  _   _    '-._
           .'     (o) (o)        '.
          /   .-._   .-.   _.-.     \\
         ;   /    '-'   '-'    \\     ;
         |  |   .-""""""""""-.  |    |
         |  |  /  .-''''''-.  \\ |    |
         |  |  | |  NOPE.  | | |    |
         |  |  \\  '-.____.-'  / |    |
         ;   \\    '-.____.-'   /    ;
          \\   '._             _.'   /
           '.     ''--...--''     .'
             '-._             _.-'
                  '--.....--'

        FAIL WHALE: "Incorrect, but I admire the confidence."
  `;

  // Rotating success animals (ASCII) + emojis
  const SUCCESS_ANIMALS = [
    {
      name: "Party Panda",
      art: `
    ï‚Ä¢·¥•‚Ä¢ î  üéâ
  /|   |\\  ‚ú®
   |___|   ü•≥
  /_____\\
      `,
      cheers: ["üéâüéâüéâ", "ü•≥‚ú®üéâ", "üéäüéâüéä", "WOOHOO!! üéâ"]
    },
    {
      name: "Clapping Cat",
      art: `
  /\_/\   üëè
 ( o.o )  üëèüëè
  > ^ <   üéâ
      `,
      cheers: ["üëèüëèüëè", "MEOWVELOUS üéâ", "PURR-FECT ‚ú®", "CAT-CHING! ü•≥"]
    },
    {
      name: "Dancing Seal",
      art: `
   (‚Ä¢„ÖÖ‚Ä¢)‚ô™
  (     )  üé∂
   "   "   ü•≥
      `,
      cheers: ["üé∂üéâ", "SEAL OF APPROVAL ‚úÖ", "BOUNCE! üï∫", "NICE! ‚ú®"]
    }
  ];

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function setStatus(text, withSpinner=false) {
    statusPill.innerHTML = withSpinner
      ? `${text} <span class="spinner" aria-hidden="true"></span>`
      : text;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  function clearBelowMsg(){
    belowMsg.innerHTML = '';
  }

  function showBelowMsg({ headline="", sub="", pre="" }){
    const parts = [];
    if (headline) parts.push(`<div class="line"><b>${headline}</b></div>`);
    if (sub) parts.push(`<div class="sub">${sub}</div>`);
    if (pre) parts.push(`<pre>${pre}</pre>`);
    belowMsg.innerHTML = parts.join('');
  }

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() {
    suggestBox.style.display = 'block';
  }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    // PREFIX-only match (startsWith)
    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    // Render list, annotate continent on right
    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0; // default to first suggestion
    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function renderFlag() {
    clearBelowMsg();
    closeSuggest();

    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    // gentle below message baseline
    showBelowMsg({
      headline: "",
      sub: `Type a country name ‚Äî or hit <b>.</b> for a hint (hint uses a try).`
    });
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        showBelowMsg({
          headline: `üèÅ Game complete! Final score: ${score}`,
          sub: `Refresh the page to play again (or smash Restart up top).`
        });
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      showBelowMsg({
        headline: `‚û°Ô∏è Next round!`,
        sub: `Round <b>${roundIdx + 1}</b> incoming‚Ä¶ sharpen your geography instincts.`
      });
      setTimeout(() => renderFlag(), 650);
      updateHUD();
      return;
    }

    renderFlag();
  }

  function successBurst(countryName, tryUsed) {
    const pts = pointsForTry(tryUsed);
    score += pts;

    const animal = pick(SUCCESS_ANIMALS);
    const cheer = pick(animal.cheers);
    const msg = pick([
      "That‚Äôs a certified globe-brain moment.",
      "Geography teacher somewhere just smiled.",
      "You‚Äôre on a roll. Don‚Äôt look down.",
      "Absolutely nailed it. No notes.",
      "Elite flag energy."
    ]);

    showBelowMsg({
      headline: `‚úÖ Correct! That was <b>${countryName}</b>. ${cheer}`,
      sub: `${msg} You earned <b>${pts}</b> point${pts === 1 ? '' : 's'}.`,
      pre: animal.art.trim()
    });

    updateHUD();
    setTimeout(() => advanceFlag(), 850);
  }

  function failQuip() {
    return pick([
      "Bold. Incorrect. Iconic.",
      "Close‚Ä¶ if we‚Äôre grading by vibes.",
      "The flag disagrees. Loudly.",
      "Somewhere, a cartographer just sneezed.",
      "You just invented a new country. The UN will be in touch.",
      "That guess just got politely escorted out."
    ]);
  }

  function acceptedNamesForCountry(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    // small alias helpers
    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');

    return accepted;
  }

  function memoryTip(c){
    const cont = continentLabel(c.region, c.subregion);
    const name = c.name.common;
    // generic, non-flag-specific mnemonic (no hallucinated colors/symbols)
    return `Memory trick: anchor <b>${name}</b> to <b>${cont}</b>. Next time you see this flag, say ‚Äú${cont} ‚Üí ${name}‚Äù out loud once. Your brain loves a tiny ritual. üß†‚ú®`;
  }

  // --- HINTS ---
  function foodHintForContinent(cont){
    const map = {
      "Europe": ["cheese üßÄ", "pastries ü•ê", "pasta vibes üçù"],
      "Asia": ["noodles üçú", "dumplings ü•ü", "spice levels üå∂Ô∏è"],
      "Africa": ["stews üç≤", "jollof debates üçö", "plantain energy üçå"],
      "North America": ["tacos üåÆ", "BBQ üî•", "maple syrup rumors üçÅ"],
      "Central America": ["beans & rice üçõ", "tropical fruit ü•≠", "coffee fuel ‚òï"],
      "Caribbean": ["rum & reggae vibes üèùÔ∏è", "jerk seasoning üå∂Ô∏è", "beach snacks ü••"],
      "South America": ["empanadas ü•ü", "arepas ü´ì", "mate moments üßâ"],
      "Oceania": ["BBQ ü•©", "pavlova whispers üç∞", "beach picnics üèñÔ∏è"],
      "Americas": ["tacos üåÆ", "BBQ üî•", "coffee fuel ‚òï"],
      "Other": ["mystery snacks üßÅ", "surprise sandwiches ü•™", "cosmic cuisine üååüç≤"]
    };
    return pick(map[cont] || map["Other"]);
  }

  function neighborsHint(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) {
      return `Neighbors: <b>none</b> (island / lonely vibes) üèùÔ∏èüòå`;
    }

    const sample = names.slice(0, 4);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Neighbors: <b>${sample.join(', ')}</b>${extra} ü§ù`;
  }

  function rhymesHint(countryName){
    const n = norm(countryName).replace(/ /g,'');
    const ends = n.slice(-3);

    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
      { suffix: 'any', words: ['many','zany','rainy','tiny'] },
    ];

    for (const p of patterns){
      if (n.endsWith(p.suffix)) {
        return `Rhymes-ish with: <b>${p.words.join(', ')}</b> üé∂`;
      }
    }

    // fallback: near-rhyme by last 3 letters
    const fallback = [
      `Ends like ‚Äú<b>${ends}</b>‚Äù‚Ä¶ so try: <b>${ends}-party</b> üéâ`,
      `If it were a rapper name: <b>DJ ${countryName.split(' ')[0]}</b> üéß`,
      `Say it dramatically and it *basically* rhymes with‚Ä¶ confidence üòé`
    ];
    return pick(fallback);
  }

  function hintForTry(c, tryUsed){
    // tryUsed: 1..3 (this hint consumes that attempt)
    const cont = continentLabel(c.region, c.subregion);
    if (tryUsed === 1) {
      const food = foodHintForContinent(cont);
      return `Hint #1: Continent: <b>${cont}</b> üåç ¬∑ Food vibe: <b>${food}</b>`;
    }
    if (tryUsed === 2) {
      return `Hint #2: ${neighborsHint(c)} (a.k.a. ‚Äúwho they share snacks with‚Äù) üó∫Ô∏è`;
    }
    return `Hint #3: ${rhymesHint(c.name.common)} (I never said it was a *good* rhyme) üòÖ`;
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;

    // If already out of tries, do nothing
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1; // using a try now
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      // Out of tries immediately after hint: reveal answer + memory tip, pause
      showBelowMsg({
        headline: `üí• Out of tries! The answer was <b>${c.name.common}</b>.`,
        sub: `${memoryTip(c)}<br/><br/>Moving on‚Ä¶`
      });
      setTimeout(() => advanceFlag(), 1600);
      return;
    }

    showBelowMsg({
      headline: `üïµÔ∏è Hint used (costs a try).`,
      sub: `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    });
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    // If suggestions are open, Enter should submit the FIRST suggestion, not typed letters
    if (suggestBox.style.display === 'block' && currentSuggestions.length) {
      const first = currentSuggestions[0];
      if (first?.name) guessInput.value = first.name;
      closeSuggest();
    }

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = acceptedNamesForCountry(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      successBurst(c.name.common, tryUsed);
      return;
    }

    // Wrong answer consumes a try
    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      // Pause, show correct answer + helpful memory hint
      showBelowMsg({
        headline: `‚ùå Nope. The correct answer was <b>${c.name.common}</b>.`,
        sub: `${failQuip()}<br/><br/>${memoryTip(c)}<br/><br/>Moving on‚Ä¶`,
        pre: FAIL_WHALE.trim()
      });
      setTimeout(() => advanceFlag(), 1800);
      return;
    }

    // Still have tries: show fail whale + nudge about hint hotkey
    showBelowMsg({
      headline: `‚ùå Not quite.`,
      sub: `${failQuip()} You have <b>${triesLeft}</b> tries left. (Tip: hit <b>.</b> for a hint ‚Äî it costs a try.)`,
      pre: FAIL_WHALE.trim()
    });

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    showBelowMsg({
      headline: `‚è≠Ô∏è Skipped. Answer: <b>${c.name.common}</b>.`,
      sub: `${memoryTip(c)}<br/><br/>Next flag‚Ä¶`
    });

    setTimeout(() => advanceFlag(), 1100);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    setStatus('Ready');
    renderFlag();
  }

  // --- Difficulty: ‚Äúfamiliarity‚Äù heuristic ---
  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }

    // Make Round 1 extra friendly
    const round1 = out[0] || [];
    const round1Names = new Set(round1.map(c => c.name.common));
    const needed = Math.max(0, 8 - round1.filter(c => WELL_KNOWN.has(c.name.common)).length);

    if (needed > 0) {
      const candidates = scored
        .map(x => x.c)
        .filter(c => WELL_KNOWN.has(c.name.common) && !round1Names.has(c.name.common));
      shuffle(candidates);
      for (let i = 0; i < Math.min(needed, candidates.length); i++) {
        round1[FLAGS_PER_ROUND - 1 - i] = candidates[i];
      }
      out[0] = round1;
    }

    return out;
  }

  async function loadCountries() {
    setStatus('Loading countries‚Ä¶', true);

    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);

    setStatus('Ready');
    restart();
  }

  // Events
  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', restart);

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => {
    if (guessInput.value) renderSuggestions(guessInput.value);
  });

  // Close suggest when clicking outside
  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  // Keyboard controls:
  // - "." => hint (consumes try)
  // - Enter => submit (uses first suggestion if visible)
  // - arrows => navigate suggestion highlight
  // - Tab => accept highlighted suggestion
  guessInput.addEventListener('keydown', (e) => {
    if (e.key === '.') {
      e.preventDefault();
      consumeTryWithHint();
      return;
    }

    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }

    if (e.key === 'Tab') {
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        e.preventDefault();
        const idx = Math.max(0, activeSuggestionIndex);
        const pick = currentSuggestions[idx];
        if (pick?.name) guessInput.value = pick.name;
        closeSuggest();
      }
      return;
    }

    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      // If suggestions open, "submit first suggestion"
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        guessInput.value = currentSuggestions[0].name;
        closeSuggest();
      }
      submitGuess();
      return;
    }
  });

  // Boot
  loadCountries().catch(err => {
    console.error(err);
    setStatus('Load failed');
    showBelowMsg({
      headline: `Couldn‚Äôt load country data.`,
      sub: `${String(err.message || err)}`
    });
  });
})();
</script>
</body>
</html>
