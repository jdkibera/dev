<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flag Gauntlet</title>

  <!-- Calligraffitti for the angled brand -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Calligraffitti&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #dfe8f4;
      --ink: #253041;
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);

      --pillBg: rgba(255,255,255,0.10);
      --btnBg: rgba(90,140,255,0.22);
      --btnBgHover: rgba(90,140,255,0.33);

      --flagStageH: 340px;
      --msgH: 230px;
      --iconColW: 120px;

      --brandBlueGrey: rgba(80, 110, 140, 0.42);
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .main{
      flex: 1;
      display: grid;
      place-items: center;
      padding: 70px 14px 10px; /* MORE top space so angled title never clips */
      position: relative;
    }

    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    /* Angled brand title anchored near modal */
    .brandAngle{
      position: absolute;
      left: -132px;
      top: 118px;             /* moved down to ensure no clipping */
      transform: rotate(-45deg);
      transform-origin: left top;
      font-family: "Calligraffitti", "Snell Roundhand", "Apple Chancery", "Segoe Script", cursive;
      font-size: 46px;
      font-weight: 400;
      color: var(--brandBlueGrey);
      user-select: none;
      pointer-events: none;
      z-index: 10;
      line-height: 0.92;
      text-align: center;     /* center Kibera over Flag Gauntlet */
      width: 250px;           /* give a stable box to center in */
    }

    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }

    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      color: #0b1020;
      display:flex;
      align-items:center;
      gap: 10px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .pill b{ font-size: 20px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      letter-spacing: 0.8px;
      font-weight: 900;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
      position: relative;
    }

    /* Modal title: Helvetica Neue ultra thin */
    .questionTitle{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 34px;
      letter-spacing: 0.3px;
      font-weight: 200;
      opacity: 0.95;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    .flagStage{
      height: var(--flagStageH);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 12px;
      box-sizing: border-box;
    }
    .flag{
      width: min(520px, 92%);
      max-height: calc(var(--flagStageH) - 18px);
      object-fit: contain;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }

    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 0px;
    }
    .controlRow{
      width: min(520px, 92%);
      display:flex;
      align-items: stretch;
      gap: 10px;
    }

    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
      align-items: stretch;
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--btnBg);
      color: #e9eefc;
      cursor: pointer;
      min-width: 96px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 0.9px;
    }
    button:hover{ background: var(--btnBgHover); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 13px;
      color: rgba(233,238,252,0.70);
      margin-top: -2px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .hintHotkeyLine b{ color: rgba(233,238,252,0.92); font-weight: 900; }

    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{ font-size: 12px; opacity: 0.70; white-space: nowrap; }

    .belowMsg{
      width: min(900px, 100%);
      height: var(--msgH);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .msgGrid{
      width: min(900px, 100%);
      display: grid;
      grid-template-columns: var(--iconColW) minmax(0, 1fr);
      align-items: start;
      gap: 14px;
      padding: 0 6px;
      box-sizing: border-box;
    }

    .iconCol{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding-top: 2px;
    }

    .iconSq{
      width: 108px;
      height: 108px;
      border-radius: 18px;
      border: none;
      background: rgba(255,255,255,0.0);
      overflow: hidden;
      display: grid;
      place-items: center;
      box-shadow: none;
    }
    .iconSq svg{
      width: 100%;
      height: 100%;
      display:block;
    }
    .iconLabel{
      font-size: 10px;
      letter-spacing: 1.2px;
      font-weight: 500;
      color: rgba(37,48,65,0.70);
      text-transform: uppercase;
      user-select:none;
      line-height: 1;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    .msgText{
      text-align: left;
      line-height: 1.25;
      align-self: start;
      padding-top: 4px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .msgText .headline{
      font-size: 18px;
      margin: 0 0 6px;
      min-height: 24px;
      color: rgba(37,48,65,0.92);
      font-weight: 400;
    }
    .msgText .sub{
      font-size: 14px;
      opacity: 0.92;
      margin: 0;
      min-height: 56px;
      color: rgba(37,48,65,0.86);
      font-weight: 300;
    }
    .msgText a{
      color: rgba(30,80,170,0.95);
      text-decoration: underline;
      font-weight: 700;
    }

    .bottomArea{
      width: 100%;
      position: relative;
    }

    .copyright{
      position: fixed;
      left: 0;
      width: 100%;
      bottom: 50px;
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      letter-spacing: 0.3px;
      z-index: 3;
      pointer-events: none;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }

    .flagFooter{
      height: 33vh;
      min-height: 220px;
      max-height: 420px;
      width: 100vw;
      position: relative;
      overflow: hidden;
      background: linear-gradient(to bottom, rgba(223,232,244,0.0), rgba(223,232,244,0.98));
    }

    .footerSvg{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 0.62;
      mask-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,1.0));
    }

    /* Full-screen confetti layer */
    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    .roundOverlay{
      position: fixed;
      inset: 0;
      display: none;
      pointer-events: none;
      z-index: 10000;
      place-items: center;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 200;
      letter-spacing: 2px;
      color: rgba(11,16,32,0.92);
      text-align: center;
    }
    .roundOverlay .big{
      font-size: min(78px, 12vw);
      padding: 22px 28px;
      border-radius: 18px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0,0,0,0.06);
    }

    @media (max-width: 900px){
      .brandAngle{ left: -122px; top: 130px; font-size: 40px; width: 230px; }
      .questionTitle{ font-size: 30px; }
    }
    @media (max-width: 760px){
      :root{ --iconColW: 112px; }
      .pill{ font-size: 16px; }
      .pill b{ font-size: 18px; }
      .questionTitle{ font-size: 26px; }
      .brandAngle{ font-size: 34px; left: -110px; top: 140px; width: 210px; }
    }
  </style>
</head>

<body>
  <div class="confettiLayer" id="confettiLayer">
    <canvas id="confettiCanvas" style="width:100%;height:100%"></canvas>
  </div>
  <div class="roundOverlay" id="roundOverlay">
    <div class="big" id="roundOverlayText">ROUND 2</div>
  </div>

  <div class="main">
    <div class="wrap">
      <div class="brandAngle">Kibera's<br/>Flag Gauntlet</div>

      <div class="topbar">
        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>
        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">RESTART</button>
        </div>
      </div>

      <div class="card" id="card">
        <div class="questionTitle">What Country's Flag Is This?</div>

        <div class="flagStage">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country nameâ€¦" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">SUBMIT</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">SKIP</button>
            </div>
          </div>

          <div class="hintHotkeyLine">
            Hit the period <b>&ldquo;.&rdquo;</b> key for a hint! (Hints cost a try.)
          </div>
        </div>
      </div>

      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">Â© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter" aria-hidden="true">
      <svg id="footerSvg" class="footerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
    </div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  const PAUSE_CORRECT_MS = 3000;  // changed
  const PAUSE_WRONG_MS   = 10000;

  // UI
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');

  const footerSvg = document.getElementById('footerSvg');

  const confettiLayer = document.getElementById('confettiLayer');
  const confettiCanvas = document.getElementById('confettiCanvas');
  const roundOverlay = document.getElementById('roundOverlay');
  const roundOverlayText = document.getElementById('roundOverlayText');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = [];
  let lastRenderedQuery = "";

  let cca3ToCountry = new Map();

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  // --- ICONS: fail whale reference style + matching simple-line animals ---
  function iconSVG(kind) {
    const stroke = "rgba(20,25,30,0.85)";
    const stroke2 = "rgba(20,25,30,0.65)";

    if (kind === 'fail') {
      // Inspired-by fail whale: blue whale + splash + little â€œx eyesâ€
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        <rect width="110" height="110" rx="18" fill="rgba(255,255,255,0)"/>
        <path d="M18 66c10 18 28 28 46 24 20-4 30-18 30-36 0-7-2-13-6-18-7 10-22 11-32 7-11-4-20-10-31-4-8 4-13 12-11 27z"
              fill="rgba(70,135,205,0.96)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <path d="M88 46c10-6 16-2 18 6-6 2-12 2-18-2z"
              fill="rgba(70,135,205,0.96)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <path d="M26 54c-7-11-2-19 9-23 2 9-2 17-9 23z"
              fill="rgba(70,135,205,0.96)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>

        <path d="M46 60l6 6M52 60l-6 6" stroke="${stroke2}" stroke-width="3" stroke-linecap="round"/>
        <path d="M60 60l6 6M66 60l-6 6" stroke="${stroke2}" stroke-width="3" stroke-linecap="round"/>

        <path d="M58 74c-7 4-16 4-23 0" fill="none" stroke="${stroke2}" stroke-width="3" stroke-linecap="round"/>
        <path d="M42 38c2-8 10-12 12-12-2 10-8 12-12 12z" fill="rgba(235,245,255,0.85)" stroke="rgba(0,0,0,0)" />
        <path d="M50 30c4-10 12-12 18-10-6 6-10 10-18 10z" fill="rgba(235,245,255,0.85)" stroke="rgba(0,0,0,0)" />
      </svg>`;
    }

    if (kind === 'success') {
      // Tony Tiger in same â€œflat fill + heavy outlineâ€ vibe
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        <rect width="110" height="110" rx="18" fill="rgba(255,255,255,0)"/>
        <path d="M26 46c-7-11-2-23 11-25l8 13z" fill="rgba(255,170,70,0.96)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <path d="M84 46c7-11 2-23-11-25l-8 13z" fill="rgba(255,170,70,0.96)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <circle cx="55" cy="60" r="34" fill="rgba(255,170,70,0.96)" stroke="${stroke}" stroke-width="3"/>
        <path d="M33 63c0-13 10-23 22-23s22 10 22 23-10 21-22 21-22-8-22-21z"
              fill="rgba(255,255,255,0.92)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <circle cx="45" cy="58" r="3.2" fill="${stroke}"/>
        <circle cx="65" cy="58" r="3.2" fill="${stroke}"/>
        <path d="M55 62c0 7-7 10-12 7" fill="none" stroke="${stroke}" stroke-width="3" stroke-linecap="round"/>
        <path d="M55 62c0 7 7 10 12 7" fill="none" stroke="${stroke}" stroke-width="3" stroke-linecap="round"/>
        <path d="M41 47c3 6 5 9 7 11M69 47c-3 6-5 9-7 11" stroke="rgba(0,0,0,0.18)" stroke-width="4" stroke-linecap="round"/>
      </svg>`;
    }

    if (kind === 'hint') {
      // Helpful Hippo in same style
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        <rect width="110" height="110" rx="18" fill="rgba(255,255,255,0)"/>
        <circle cx="55" cy="60" r="34" fill="rgba(170,185,225,0.96)" stroke="${stroke}" stroke-width="3"/>
        <circle cx="35" cy="40" r="10" fill="rgba(170,185,225,0.96)" stroke="${stroke}" stroke-width="3"/>
        <circle cx="75" cy="40" r="10" fill="rgba(170,185,225,0.96)" stroke="${stroke}" stroke-width="3"/>
        <path d="M35 72c0-11 9-19 20-19s20 8 20 19-8 17-20 17-20-6-20-17z"
              fill="rgba(255,255,255,0.92)" stroke="${stroke}" stroke-width="3" stroke-linejoin="round"/>
        <circle cx="45" cy="56" r="3.1" fill="${stroke}"/>
        <circle cx="65" cy="56" r="3.1" fill="${stroke}"/>
        <circle cx="48" cy="70" r="3" fill="rgba(20,25,30,0.30)"/>
        <circle cx="62" cy="70" r="3" fill="rgba(20,25,30,0.30)"/>
        <path d="M55 74c-3 4-7 4-10 0" stroke="rgba(20,25,30,0.42)" stroke-width="3" fill="none" stroke-linecap="round"/>
        <path d="M82 28l6 0M85 25l0 6" stroke="rgba(20,25,30,0.45)" stroke-width="3" stroke-linecap="round"/>
      </svg>`;
    }

    // default: globe/map
    return `
    <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
      <rect width="110" height="110" rx="18" fill="rgba(255,255,255,0)"/>
      <circle cx="55" cy="55" r="34" fill="rgba(120,170,220,0.30)" stroke="rgba(20,25,30,0.75)" stroke-width="3"/>
      <path d="M21 55h68" stroke="rgba(20,25,30,0.40)" stroke-width="3"/>
      <path d="M55 21v68" stroke="rgba(20,25,30,0.25)" stroke-width="3"/>
      <path d="M30 40c8-8 18-12 26-12" stroke="rgba(20,25,30,0.40)" stroke-width="3" fill="none" stroke-linecap="round"/>
      <path d="M30 70c8 8 18 12 26 12" stroke="rgba(20,25,30,0.40)" stroke-width="3" fill="none" stroke-linecap="round"/>
    </svg>`;
  }

  function renderMsg(kind, iconName, headline, sub){
    belowMsg.innerHTML = `
      <div class="msgGrid">
        <div class="iconCol">
          <div class="iconSq" aria-hidden="true">${iconSVG(kind)}</div>
          <div class="iconLabel">${iconName || ""}</div>
        </div>
        <div class="msgText">
          <div class="headline">${headline || ""}</div>
          <div class="sub">${sub || ""}</div>
        </div>
      </div>
    `;
  }

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() { suggestBox.style.display = 'block'; }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0;

    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function applySuggestionSelectionToInput() {
    if (suggestBox.style.display !== 'block') return false;
    if (!currentSuggestions.length) return false;

    const idx = Math.max(0, activeSuggestionIndex);
    const pickItem = currentSuggestions[idx] || currentSuggestions[0];
    if (pickItem?.name) {
      guessInput.value = pickItem.name;
      closeSuggest();
      return true;
    }
    return false;
  }

  function currentAcceptedNames(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');
    return accepted;
  }

  function fmtNumber(n){
    if (!Number.isFinite(n)) return 'â€”';
    return n.toLocaleString('en-US');
  }

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Â· <b><i>Neighbors</i></b>: <b>none</b> (island / solo mode) ğŸï¸`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Â· <b><i>Neighbors</i></b>: ${sample.join(', ')}${extra} ğŸ¤`;
  }

  const FOOD_HINT = {
    "Iran": `date palms & saffron rice with meat (<i>Chelo Kabab</i>) ğŸšğŸ¥©`,
    "Peru": `ceviche + lomo saltado ğŸŸğŸ¥”`,
    "Japan": `sushi + ramen ğŸ£ğŸœ`,
    "Italy": `pasta + espresso ğŸâ˜•`,
    "Mexico": `tacos al pastor + mole ğŸŒ®ğŸ«`,
    "India": `biryani + masala chai ğŸ›â˜•`,
    "Thailand": `pad thai + green curry ğŸŒ¶ï¸ğŸœ`,
    "Turkey": `kebabs + baklava ğŸ¥™ğŸ¯`,
    "Morocco": `tagine + mint tea ğŸ«–ğŸ²`,
    "Ethiopia": `injera + wats ğŸ²`,
    "France": `croissant + cheese ğŸ¥ğŸ§€`,
    "United States": `burgers + BBQ ğŸ”ğŸ”¥`,
    "Australia": `flat white + meat pie + â€œbarbieâ€ culture â˜•ğŸ¥§`
  };

  // Expanded famous people list, incl. Australia and more coverage.
  const FAMOUS_PERSON = {
    "Australia": "Chris Hemsworth (actor) ğŸ¬",
    "New Zealand": "Taika Waititi (filmmaker) ğŸ¬",
    "United States": "BeyoncÃ© (musician) ğŸ¤",
    "Canada": "Ryan Reynolds (actor) ğŸ¬",
    "United Kingdom": "David Bowie (musician) ğŸ¸",
    "Ireland": "Bono (musician) ğŸ¤",
    "France": "Marie Curie (scientist) âš—ï¸",
    "Germany": "Albert Einstein (scientist) ğŸ§ ",
    "Italy": "Leonardo da Vinci (artist) ğŸ¨",
    "Spain": "Pablo Picasso (artist) ğŸ–¼ï¸",
    "Portugal": "Cristiano Ronaldo (athlete) âš½",
    "Netherlands": "Vincent van Gogh (artist) ğŸ¨",
    "Belgium": "Audrey Hepburn (actor) ğŸï¸",
    "Switzerland": "Roger Federer (athlete) ğŸ¾",
    "Austria": "Wolfgang Amadeus Mozart (composer) ğŸ¼",
    "Sweden": "Greta Thunberg (activist) ğŸŒ",
    "Norway": "Edvard Munch (artist) ğŸ–¼ï¸",
    "Denmark": "Hans Christian Andersen (writer) ğŸ“š",
    "Finland": "Linus Torvalds (tech) ğŸ’»",
    "Iceland": "BjÃ¶rk (musician) ğŸ¤",
    "Russia": "Leo Tolstoy (writer) ğŸ“š",
    "Ukraine": "Volodymyr Zelenskyy (leader) ğŸ—³ï¸",
    "Poland": "FrÃ©dÃ©ric Chopin (composer) ğŸ¹",
    "Greece": "Aristotle (philosopher) ğŸ›ï¸",
    "Turkey": "Mustafa Kemal AtatÃ¼rk (leader) ğŸ§­",
    "Israel": "Golda Meir (leader) ğŸ—³ï¸",
    "Egypt": "Omar Sharif (actor) ğŸï¸",
    "South Africa": "Nelson Mandela (leader) âœŠ",
    "Nigeria": "Chimamanda Ngozi Adichie (writer) ğŸ“š",
    "Kenya": "Wangari Maathai (scientist) ğŸŒ³",
    "Ethiopia": "Haile Selassie (leader) ğŸ‘‘",
    "Ghana": "Kofi Annan (leader) ğŸ•Šï¸",
    "Morocco": "Ibn Battuta (explorer) ğŸ§­",
    "Tunisia": "Hannibal (general) ğŸ˜",
    "Saudi Arabia": "MBS (leader) ğŸ›ï¸",
    "United Arab Emirates": "Burj Khalifa (icon) ğŸ™ï¸",
    "Qatar": "Al Jazeera (media) ğŸ“º",
    "Iran": "Rumi (poet) ğŸ“œ",
    "Iraq": "Mesopotamia (history) ğŸº",
    "Jordan": "Queen Rania (public figure) ğŸ‘‘",
    "Lebanon": "Kahlil Gibran (writer) ğŸ“š",
    "China": "Jackie Chan (actor) ğŸ¥",
    "Japan": "Hayao Miyazaki (filmmaker) ğŸ¬",
    "South Korea": "BTS (musicians) ğŸ¤",
    "India": "Mahatma Gandhi (leader) ğŸ•Šï¸",
    "Pakistan": "Malala Yousafzai (activist) ğŸ“",
    "Bangladesh": "Muhammad Yunus (economist) ğŸ’¡",
    "Sri Lanka": "M.I.A. (musician) ğŸ¤",
    "Thailand": "Tony Jaa (actor) ğŸ¥‹",
    "Vietnam": "Ho Chi Minh (leader) ğŸ§­",
    "Indonesia": "Sukarno (leader) ğŸ—³ï¸",
    "Philippines": "Manny Pacquiao (athlete) ğŸ¥Š",
    "Malaysia": "Michelle Yeoh (actor) ğŸ¬",
    "Singapore": "Lee Kuan Yew (leader) ğŸ›ï¸",
    "Brazil": "PelÃ© (athlete) âš½",
    "Argentina": "Lionel Messi (athlete) âš½",
    "Mexico": "Frida Kahlo (artist) ğŸ¨",
    "Colombia": "Shakira (musician) ğŸ¤",
    "Chile": "Pablo Neruda (poet) ğŸ“œ",
    "Peru": "Mario Vargas Llosa (writer) ğŸ“š"
  };

  const SYMBOLISM_ONE_LINER = {
    "Peru": "Red honors sacrifice in the independence struggle; white stands for peace/purity.",
    "Iran": "Green/white/red are tied to growth/peace/courage; emblem/pattern reference Islamic identity.",
    "Japan": "Red sun disc represents the sunâ€”Japan as the â€˜land of the rising sun.â€™",
    "France": "Tricolor tied to the Revolution; often read as liberty/equality/fraternity."
  };

  function rjSlugForCountry(name){
    const slug = name.toLowerCase()
      .replace(/â€™/g,'')
      .replace(/'/g,'')
      .replace(/&/g,'and')
      .replace(/[^a-z0-9 ]/g,'')
      .trim()
      .replace(/\s+/g,'-');
    return `https://www.rjtravelagency.com/flag-of-${slug}/`;
  }

  function symbolismBlock(c){
    const name = c.name.common;
    const one = SYMBOLISM_ONE_LINER[name];
    const url = rjSlugForCountry(name);
    return one
      ? `<b>Flag meaning:</b> ${one}`
      : `<b>Flag meaning:</b> Quick reference: <a href="${url}" target="_blank" rel="noopener">RJ Travel Agency</a>.`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles/rice + a signature spice combo ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked magic ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things ğŸ¥©ğŸŒ½",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return [
        `Â· <b><i>Continent</i></b>: ${cont} ğŸŒ`,
        `Â· <b><i>Food</i></b>: ${hint1Food(c)}`
      ].join('<br/>');
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] || `A-list vibes (${continentLabel(c.region, c.subregion)}) â­`;
      return [
        `Â· <b><i>Famous Name</i></b>: ${celeb}`,
        `Â· <b><i>Stat</i></b>: population ${pop} ğŸ‘¥`,
        neighborsList(c)
      ].join('<br/>');
    }

    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Â· <b><i>Rhymes-ish</i></b>: ${p.words.join(', ')} ğŸ¶`;
    }
    return `Â· <b><i>Sound clue</i></b>: ends like â€œ${ends}â€â€¦ try yelling â€œ${ends}!â€ dramatically ğŸ­`;
  }

  function renderFlag() {
    closeSuggest();
    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    renderMsg('neutral','WORLD MAP','', `Type a country name â€” or hit <b>.</b> for a hint (hint uses a try).`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  // --- Confetti ---
  function confettiBurst(ms=1800){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);

    confettiCanvas.width = w;
    confettiCanvas.height = h;

    const ctx = confettiCanvas.getContext('2d');
    const pieces = [];
    const colors = ['#ff6b6b','#ffd93d','#6bcBef','#6bff95','#b36bff','#ff9f43'];

    const count = 220;
    for (let i=0;i<count;i++){
      pieces.push({
        x: Math.random()*w,
        y: -20 - Math.random()*h*0.2,
        vx: (Math.random()*2-1) * dpr * 2.2,
        vy: (Math.random()*1+2) * dpr * 3.2,
        r: (Math.random()*4+3) * dpr,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*0.2-0.1),
        c: colors[Math.floor(Math.random()*colors.length)],
        life: Math.random()*0.6 + 0.4
      });
    }

    confettiLayer.style.display = 'block';

    const start = performance.now();
    function tick(t){
      const p = Math.min(1, (t-start)/ms);
      ctx.clearRect(0,0,w,h);

      for (const s of pieces){
        s.x += s.vx;
        s.y += s.vy;
        s.rot += s.vr;
        s.vy += 0.03 * dpr; // gravity
        const alpha = Math.max(0, (1 - p) * s.life);

        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = s.c;
        ctx.fillRect(-s.r, -s.r, s.r*2.2, s.r*1.2);
        ctx.restore();
      }

      if (p < 1) requestAnimationFrame(tick);
      else confettiLayer.style.display = 'none';
    }
    requestAnimationFrame(tick);
  }

  function roundTransition(nextRoundNumber){
    roundOverlayText.textContent = `ROUND ${nextRoundNumber}`;
    roundOverlay.style.display = 'grid';
    confettiBurst(2200);

    // overlay dissolves into confetti
    setTimeout(() => {
      roundOverlay.style.display = 'none';
      renderFlag();
    }, 2300);
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success','TONY TIGER',`ğŸ Game complete! Final score: <b>${score}</b> ğŸ‰`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      updateHUD();
      roundTransition(roundIdx + 1);
      return;
    }

    renderFlag();
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        'FAIL WHALE',
        `Out of tries! Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      'HELPFUL HIPPO',
      `Hint Used (costs a try!)`,
      `${hint}<br/><br/>You have <b><i>${triesLeft}</i></b> tries left.`
    );
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = currentAcceptedNames(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const emoji = pick(["ğŸ‰","ğŸ¥³","âœ¨"]); // max 1 here; title only
      renderMsg(
        'success',
        'TONY TIGER',
        `Correct! That was <b>${c.name.common}</b>. ${emoji}`,
        `You earned <b>${pts}</b> point${pts === 1 ? '' : 's'}.<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        'FAIL WHALE',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      'FAIL WHALE',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left. (Hit <b>.</b> for a hint â€” it costs a try.)`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'neutral',
      'WORLD MAP',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    renderFlag();
  }

  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }
    return out;
  }

  // Footer: scattered flags (as previous rev)
  function buildFooter() {
    const w = Math.max(1200, window.innerWidth);
    const h = Math.max(220, Math.floor(window.innerHeight * 0.33));
    footerSvg.setAttribute('viewBox', `0 0 ${w} ${h}`);
    footerSvg.innerHTML = '';

    const NS = 'http://www.w3.org/2000/svg';
    const defs = document.createElementNS(NS,'defs');

    function makeOutlineTemplate(id, drawFn){
      const g = document.createElementNS(NS,'g');
      g.setAttribute('id', id);
      drawFn(g);
      defs.appendChild(g);
    }

    function rect(g, x,y,ww,hh, fill, stroke, sw){
      const r = document.createElementNS(NS,'rect');
      r.setAttribute('x', x); r.setAttribute('y', y);
      r.setAttribute('width', ww); r.setAttribute('height', hh);
      r.setAttribute('rx', 0); r.setAttribute('ry', 0);
      r.setAttribute('fill', fill);
      r.setAttribute('stroke', stroke);
      r.setAttribute('stroke-width', sw);
      g.appendChild(r);
      return r;
    }
    function line(g, x1,y1,x2,y2, stroke, sw){
      const l = document.createElementNS(NS,'line');
      l.setAttribute('x1', x1); l.setAttribute('y1', y1);
      l.setAttribute('x2', x2); l.setAttribute('y2', y2);
      l.setAttribute('stroke', stroke);
      l.setAttribute('stroke-width', sw);
      l.setAttribute('stroke-linecap','round');
      g.appendChild(l);
      return l;
    }
    function circle(g, cx,cy,r, fill, stroke, sw){
      const c = document.createElementNS(NS,'circle');
      c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', r);
      c.setAttribute('fill', fill);
      if (stroke){ c.setAttribute('stroke', stroke); c.setAttribute('stroke-width', sw); }
      g.appendChild(c);
      return c;
    }
    function path(g, d, fill, stroke, sw){
      const p = document.createElementNS(NS,'path');
      p.setAttribute('d', d);
      p.setAttribute('fill', fill);
      if (stroke){ p.setAttribute('stroke', stroke); p.setAttribute('stroke-width', sw); }
      p.setAttribute('stroke-linejoin','round');
      g.appendChild(p);
      return p;
    }

    const strokeOutline = 'rgba(37,48,65,0.55)';
    const strokeThin = 'rgba(37,48,65,0.30)';

    makeOutlineTemplate('tpl-us', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      for (let y=5;y<=25;y+=5) line(g,0,y,44,y,strokeThin,1.2);
      rect(g,0,0,18,14,'none',strokeThin,1.2);
    });
    makeOutlineTemplate('tpl-uk', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      path(g,'M0 0 L44 26 M44 0 L0 26','none',strokeThin,1.1);
      line(g,0,13,44,13,'rgba(37,48,65,0.40)',1.7);
      line(g,22,0,22,26,'rgba(37,48,65,0.40)',1.7);
    });
    makeOutlineTemplate('tpl-jp', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      circle(g,22,13,7,'none','rgba(37,48,65,0.40)',1.7);
    });
    makeOutlineTemplate('tpl-fr', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      line(g,14.7,0,14.7,26,'rgba(37,48,65,0.35)',1.7);
      line(g,29.3,0,29.3,26,'rgba(37,48,65,0.35)',1.7);
    });
    makeOutlineTemplate('tpl-de', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      line(g,0,8.7,44,8.7,'rgba(37,48,65,0.35)',1.7);
      line(g,0,17.4,44,17.4,'rgba(37,48,65,0.35)',1.7);
    });
    makeOutlineTemplate('tpl-br', (g)=>{
      rect(g,0,0,44,26,'none',strokeOutline,1.5);
      path(g,'M22 3 L39 13 L22 23 L5 13 Z','none','rgba(37,48,65,0.35)',1.7);
      circle(g,22,13,5,'none','rgba(37,48,65,0.25)',1.2);
    });

    footerSvg.appendChild(defs);

    const templates = ['tpl-us','tpl-uk','tpl-jp','tpl-fr','tpl-de','tpl-br'];

    const flagW = 45;
    const spacing = 18;
    const approxCount = Math.floor((w * h) / ((flagW + spacing) * (flagW + spacing) * 1.55));
    const count = Math.max(180, Math.min(520, approxCount));

    const coloredCount = Math.max(1, Math.floor(count * 0.10));
    const coloredIdx = new Set();
    while (coloredIdx.size < coloredCount) coloredIdx.add(Math.floor(Math.random() * count));

    function randColor(i){
      const h1 = (i * 137.508) % 360;
      const s = 55 + (i % 20);
      const l = 60;
      return `hsla(${h1}, ${s}%, ${l}%, 0.28)`;
    }

    const NS2 = 'http://www.w3.org/2000/svg';
    for (let i = 0; i < count; i++) {
      const id = pick(templates);
      const useColored = coloredIdx.has(i);

      const x = Math.random() * (w + 80) - 40;
      const y = Math.random() * (h + 40) - 20;

      const rot = (Math.random() * 10 - 5);
      const scale = flagW / 44 * (0.92 + Math.random() * 0.18);

      const g = document.createElementNS(NS2,'g');
      g.setAttribute('transform', `translate(${x},${y}) rotate(${rot}) scale(${scale})`);

      if (useColored) {
        rect(g,0,0,44,26,randColor(i),'rgba(0,0,0,0)',0);
      }

      const use = document.createElementNS(NS2,'use');
      use.setAttribute('href', `#${id}`);
      g.appendChild(use);

      const alpha = 0.20 + (y / h) * 0.55;
      g.setAttribute('opacity', String(Math.max(0.06, Math.min(0.70, alpha))));

      footerSvg.appendChild(g);
    }
  }

  // Events
  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', () => { restart(); buildFooter(); });

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => { if (guessInput.value) renderSuggestions(guessInput.value); });

  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }
    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        applySuggestionSelectionToInput();
      }
      submitGuess();
      return;
    }
  });

  // Global "." hint regardless of focus
  document.addEventListener('keydown', (e) => {
    if (e.key !== '.') return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;
    const t = e.target;
    const isTextField = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') && !t.readOnly && !t.disabled;
    if (isTextField) e.preventDefault();
    consumeTryWithHint();
    guessInput.focus();
  });

  // Boot
  async function loadCountries() {
    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);
    buildFooter();
    restart();
  }

  loadCountries().catch(err => {
    console.error(err);
    renderMsg('fail','FAIL WHALE',`Couldnâ€™t load country data.`, `${String(err.message || err)}`);
  });

  window.addEventListener('resize', () => buildFooter());
})();
</script>
</body>
</html>
