<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flag Gauntlet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Calligraffitti&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #dfe8f4;
      --ink: #253041;
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);

      --pillBg: rgba(255,255,255,0.10);

      --flagStageH: 340px;

      /* Messaging area: fixed layout so nothing jumps */
      --msgH: 320px;
      --iconColW: 150px;

      --brandBlueGrey: rgba(80, 110, 140, 0.42);
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .main{
      flex: 1;
      display: grid;
      place-items: center;
      padding: 70px 14px 10px;
      position: relative;
      z-index: 2;
    }

    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    .brandAngle{
      position: absolute;
      left: -132px;
      top: 118px;
      transform: rotate(-45deg);
      transform-origin: left top;
      font-family: "Calligraffitti", "Snell Roundhand", "Apple Chancery", "Segoe Script", cursive;
      font-size: 46px;
      font-weight: 400;
      color: var(--brandBlueGrey);
      user-select: none;
      pointer-events: none;
      z-index: 10;
      line-height: 0.92;
      text-align: center;
      width: 250px;
    }

    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }

    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      color: #0b1020;
      display:flex;
      align-items:center;
      gap: 10px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .pill b{ font-size: 20px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      letter-spacing: 0.8px;
      font-weight: 900;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
      position: relative;
    }

    .questionTitle{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 34px;
      letter-spacing: 0.3px;
      font-weight: 200;
      opacity: 0.95;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    .flagStage{
      height: var(--flagStageH);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 12px;
      box-sizing: border-box;
    }
    .flag{
      width: min(520px, 92%);
      max-height: calc(var(--flagStageH) - 18px);
      object-fit: contain;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }

    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 0px;
    }
    .controlRow{
      width: min(520px, 92%);
      display:flex;
      align-items: stretch;
      gap: 10px;
    }

    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
      align-items: stretch;
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(90,140,255,0.22);
      color: #e9eefc;
      cursor: pointer;
      min-width: 96px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 0.9px;
    }
    button:hover{ background: rgba(90,140,255,0.33); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 13px;
      color: rgba(233,238,252,0.70);
      margin-top: -2px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .hintHotkeyLine b{ color: rgba(233,238,252,0.92); font-weight: 700; }

    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{ font-size: 12px; opacity: 0.70; white-space: nowrap; }

    /* Messaging area: fixed layout so nothing jumps */
    .belowMsg{
      width: min(900px, 100%);
      height: var(--msgH);
      display: grid;
      place-items: center;
      overflow: hidden;
      z-index: 2;
      position: relative;
    }

    .msgGrid{
      width: min(900px, 100%);
      display: grid;
      grid-template-columns: var(--iconColW) minmax(0, 1fr);
      align-items: start;
      gap: 18px;
      padding: 0 6px;
      box-sizing: border-box;
    }

    .iconCol{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding-top: 2px;
    }

    .iconSq{
      width: 132px;
      height: 132px;
      border-radius: 18px;
      border: none;
      background: rgba(255,255,255,0.0);
      overflow: hidden;
      display: grid;
      place-items: center;
      box-shadow: none;
    }
    .iconSq svg{
      width: 100%;
      height: 100%;
      display:block;
    }
    .iconLabel{
      font-size: 11px;
      letter-spacing: 1.4px;
      font-weight: 500;
      color: rgba(37,48,65,0.70);
      text-transform: uppercase;
      user-select:none;
      line-height: 1;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    /* Messaging typography: 20% smaller + softer bold */
    .msgText{
      text-align: left;
      line-height: 1.25;
      align-self: start;
      padding-top: 6px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .msgText .headline{
      font-size: 29px;   /* was 36 */
      margin: 0 0 10px;
      min-height: 36px;  /* was 42 */
      color: rgba(37,48,65,0.92);
      font-weight: 320;
    }
    .msgText .sub{
      font-size: 22px;   /* was 28 */
      opacity: 0.92;
      margin: 0;
      min-height: 96px;  /* tuned for smaller text */
      color: rgba(37,48,65,0.86);
      font-weight: 300;
    }
    .msgText b{ font-weight: 650; } /* was 800 */
    .msgText a{
      color: rgba(30,80,170,0.95);
      text-decoration: underline;
      font-weight: 650;
    }

    .bottomArea{
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .copyright{
      position: fixed;
      left: 0;
      width: 100%;
      bottom: 50px;
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      letter-spacing: 0.3px;
      z-index: 3;
      pointer-events: none;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }

    /* Footer begins AFTER message box (JS sets top/height). Fades in from that point. */
    .flagFooter{
      position: fixed;
      left: 0;
      width: 100vw;
      bottom: 0;
      top: auto;           /* JS will set top */
      height: 0px;         /* JS will set height */
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      background: none;    /* fade handled by mask */
    }
    
    .footerSvg{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 1;
    
      /* fade-in AFTER the message box: top is transparent -> visible below */
      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0.00) 0%,
        rgba(0,0,0,0.00) 12%,
        rgba(0,0,0,0.35) 28%,
        rgba(0,0,0,1.00) 55%,
        rgba(0,0,0,1.00) 100%
      );
    }

    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    .roundOverlay{
      position: fixed;
      inset: 0;
      display: none;
      pointer-events: none;
      z-index: 10000;
      place-items: center;
      text-align: center;
    }
    .roundOverlay .big{
      font-family: "Calligraffitti", cursive;
      font-weight: 400;
      font-size: min(140px, 16vw);
      line-height: 0.95;
      color: rgba(11,16,32,0.86);
      padding: 10px 18px;
      border-radius: 18px;
      background: rgba(255,255,255,0.35);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(0,0,0,0.06);
    }

    @media (max-width: 900px){
      .brandAngle{ left: -122px; top: 130px; font-size: 40px; width: 230px; }
      .questionTitle{ font-size: 30px; }
      .iconSq{ width: 120px; height: 120px; }
      :root{ --iconColW: 140px; --msgH: 300px; }
      .msgText .headline{ font-size: 26px; }
      .msgText .sub{ font-size: 20px; }
    }
    @media (max-width: 760px){
      :root{ --iconColW: 132px; --msgH: 290px; }
      .pill{ font-size: 16px; }
      .pill b{ font-size: 18px; }
      .questionTitle{ font-size: 26px; }
      .brandAngle{ font-size: 34px; left: -110px; top: 140px; width: 210px; }
    }
  </style>
</head>

<body>
  <div class="confettiLayer" id="confettiLayer">
    <canvas id="confettiCanvas" style="width:100%;height:100%"></canvas>
  </div>
  <div class="roundOverlay" id="roundOverlay">
    <div class="big" id="roundOverlayText">ROUND 2!</div>
  </div>

  <div class="main">
    <div class="wrap">
      <div class="brandAngle">Kibera's<br/>Flag Gauntlet</div>

      <div class="topbar">
        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>
        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">RESTART</button>
        </div>
      </div>

      <div class="card" id="card">
        <div class="questionTitle">What Country's Flag Is This?</div>

        <div class="flagStage">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country nameâ€¦" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">SUBMIT</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">SKIP</button>
            </div>
          </div>

          <div class="hintHotkeyLine">
            Hit the period <b>&ldquo;.&rdquo;</b> key for a hint! (Hints cost a try.)
          </div>
        </div>
      </div>

      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">Â© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter" aria-hidden="true">
      <svg id="footerSvg" class="footerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
    </div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  const PAUSE_CORRECT_MS = 3000;
  const PAUSE_WRONG_MS   = 10000;

  // UI
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');

  const footerSvg = document.getElementById('footerSvg');

  const confettiLayer = document.getElementById('confettiLayer');
  const confettiCanvas = document.getElementById('confettiCanvas');
  const roundOverlay = document.getElementById('roundOverlay');
  const roundOverlayText = document.getElementById('roundOverlayText');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = [];
  let lastRenderedQuery = "";

  let cca3ToCountry = new Map();

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  // --- Much more hand-drawn icon set: wobble filter + double-stroke + scribbles ---
  function iconSVG(kind) {
    const strokeA = "rgba(18,22,26,0.85)";
    const strokeB = "rgba(18,22,26,0.45)";
    const wash = "rgba(120,155,200,0.20)";
    const paper = "rgba(255,255,255,0.76)";

    const defs = `
      <defs>
        <filter id="wobble">
          <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="2" seed="7" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="2.0" xChannelSelector="R" yChannelSelector="G"/>
        </filter>

        <pattern id="hatch" width="10" height="10" patternUnits="userSpaceOnUse" patternTransform="rotate(22)">
          <line x1="0" y1="0" x2="0" y2="10" stroke="rgba(18,22,26,0.14)" stroke-width="2"/>
        </pattern>
      </defs>
    `;

    function dblPath(d, fill="none", sw=3.2){
      return `
        <path d="${d}" fill="${fill}" stroke="${strokeA}" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="${d}" fill="none" stroke="${strokeB}" stroke-width="${Math.max(1.4, sw-1.4)}" stroke-linecap="round" stroke-linejoin="round"
              transform="translate(0.9,0.6)"/>
      `;
    }
    function scribble(x1,y1,x2,y2){
      return `<path d="M${x1} ${y1} C${(x1+x2)/2} ${y1-6}, ${(x1+x2)/2} ${y2+6}, ${x2} ${y2}"
                fill="none" stroke="rgba(18,22,26,0.18)" stroke-width="2.2" stroke-linecap="round"/>`;
    }

    // Globe (WORLD MAP)
    if (kind === 'neutral') {
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        ${defs}
        <rect width="110" height="110" rx="18" fill="${paper}"/>
        <g filter="url(#wobble)">
          ${dblPath("M55 20 A35 35 0 1 1 54.9 20", "url(#hatch)", 3.6)}
          ${dblPath("M20 55 H90", "none", 3.0)}
          ${dblPath("M55 20 V90", "none", 2.6)}
          ${dblPath("M30 35 C40 28, 46 28, 52 34 C48 42, 40 45, 34 42 C32 40, 31 38, 30 35", wash, 2.6)}
          ${dblPath("M62 40 C70 34, 78 36, 82 44 C80 52, 73 55, 66 52 C63 50, 62 46, 62 40", wash, 2.6)}
          ${dblPath("M36 66 C42 60, 48 60, 52 66 C48 72, 42 74, 38 72 C36 70, 35 68, 36 66", wash, 2.4)}
          ${scribble(30,82,80,78)}
          ${scribble(28,28,78,30)}
        </g>
      </svg>`;
    }

    // Fail whale
    if (kind === 'fail') {
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        ${defs}
        <rect width="110" height="110" rx="18" fill="${paper}"/>
        <g filter="url(#wobble)">
          ${dblPath("M18 66 C22 50, 36 40, 54 42 C68 44, 82 38, 92 46 C98 52, 98 62, 90 68 C82 74, 70 78, 54 78 C38 78, 26 74, 18 66", "url(#hatch)", 3.6)}
          ${dblPath("M86 54 C96 48, 102 54, 100 64 C94 64, 90 60, 86 54", wash, 2.8)}
          ${dblPath("M34 58 C40 56, 46 56, 52 58", "none", 2.6)}
          <circle cx="42" cy="56" r="2.8" fill="rgba(18,22,26,0.78)"/>
          ${dblPath("M44 69 C52 74, 62 74, 70 69", "none", 2.8)}
          ${dblPath("M58 36 C60 30, 64 30, 66 36", "none", 2.6)}
          ${dblPath("M62 36 C66 28, 70 28, 72 36", "none", 2.3)}
          ${scribble(22,86,88,82)}
        </g>
      </svg>`;
    }

    // Tony tiger (stylized tiger face)
    if (kind === 'success') {
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        ${defs}
        <rect width="110" height="110" rx="18" fill="${paper}"/>
        <g filter="url(#wobble)">
          ${dblPath("M26 45 C18 34, 22 24, 36 22 L44 34 C38 40, 32 44, 26 45", wash, 3.0)}
          ${dblPath("M84 45 C92 34, 88 24, 74 22 L66 34 C72 40, 78 44, 84 45", wash, 3.0)}
          ${dblPath("M25 60 C25 42, 39 30, 55 30 C71 30, 85 42, 85 60 C85 78, 72 88, 55 88 C38 88, 25 78, 25 60", "url(#hatch)", 3.6)}
          ${dblPath("M37 62 C37 52, 45 46, 55 46 C65 46, 73 52, 73 62 C73 72, 65 78, 55 78 C45 78, 37 72, 37 62", paper, 3.0)}
          <circle cx="46" cy="60" r="2.8" fill="rgba(18,22,26,0.78)"/>
          <circle cx="64" cy="60" r="2.8" fill="rgba(18,22,26,0.78)"/>
          ${dblPath("M55 64 C52 66, 50 68, 49 70 C55 72, 61 72, 67 70 C66 68, 64 66, 55 64", wash, 2.8)}
          ${dblPath("M40 52 L46 56", "none", 2.6)}
          ${dblPath("M70 52 L64 56", "none", 2.6)}
          ${dblPath("M44 48 L50 54", "none", 2.2)}
          ${dblPath("M66 48 L60 54", "none", 2.2)}
          ${scribble(28,84,82,86)}
        </g>
      </svg>`;
    }

    // Helpful hippo (hippo face)
    if (kind === 'hint') {
      return `
      <svg viewBox="0 0 110 110" xmlns="http://www.w3.org/2000/svg">
        ${defs}
        <rect width="110" height="110" rx="18" fill="${paper}"/>
        <g filter="url(#wobble)">
          ${dblPath("M25 62 C25 44, 39 32, 55 32 C71 32, 85 44, 85 62 C85 80, 72 90, 55 90 C38 90, 25 80, 25 62", "url(#hatch)", 3.6)}
          ${dblPath("M33 48 C29 38, 34 30, 44 32 C46 38, 42 46, 33 48", wash, 2.8)}
          ${dblPath("M77 48 C81 38, 76 30, 66 32 C64 38, 68 46, 77 48", wash, 2.8)}
          ${dblPath("M36 70 C36 60, 44 54, 55 54 C66 54, 74 60, 74 70 C74 80, 66 84, 55 84 C44 84, 36 80, 36 70", paper, 3.0)}
          <circle cx="46" cy="64" r="2.8" fill="rgba(18,22,26,0.78)"/>
          <circle cx="64" cy="64" r="2.8" fill="rgba(18,22,26,0.78)"/>
          ${dblPath("M55 74 C50 78, 45 78, 40 74", "none", 2.6)}
          ${dblPath("M55 74 C60 78, 65 78, 70 74", "none", 2.6)}
          ${dblPath("M83 28 L89 28 M86 25 L86 31", "none", 2.6)}
          ${scribble(26,86,84,82)}
        </g>
      </svg>`;
    }

    return '';
  }

  function renderMsg(kind, iconName, headline, sub){
    belowMsg.innerHTML = `
      <div class="msgGrid">
        <div class="iconCol">
          <div class="iconSq" aria-hidden="true">${iconSVG(kind)}</div>
          <div class="iconLabel">${iconName || ""}</div>
        </div>
        <div class="msgText">
          <div class="headline">${headline || ""}</div>
          <div class="sub">${sub || ""}</div>
        </div>
      </div>
    `;
  }

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() { suggestBox.style.display = 'block'; }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0;

    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function applySuggestionSelectionToInput() {
    if (suggestBox.style.display !== 'block') return false;
    if (!currentSuggestions.length) return false;

    const idx = Math.max(0, activeSuggestionIndex);
    const pickItem = currentSuggestions[idx] || currentSuggestions[0];
    if (pickItem?.name) {
      guessInput.value = pickItem.name;
      closeSuggest();
      return true;
    }
    return false;
  }

  function currentAcceptedNames(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');
    return accepted;
  }

  function fmtNumber(n){
    if (!Number.isFinite(n)) return 'â€”';
    return n.toLocaleString('en-US');
  }

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Â· <b>Neighbors</b>: <b>none</b> (island / solo mode) ğŸï¸`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Â· <b>Neighbors</b>: ${sample.join(', ')}${extra} ğŸ¤`;
  }

  const FOOD_HINT = {
    "Iran": `date palms & saffron rice with meat (Chelo Kabab) ğŸšğŸ¥©`,
    "Peru": `ceviche + lomo saltado ğŸŸğŸ¥”`,
    "Japan": `sushi + ramen ğŸ£ğŸœ`,
    "Italy": `pasta + espresso ğŸâ˜•`,
    "Mexico": `tacos al pastor + mole ğŸŒ®ğŸ«`,
    "India": `biryani + masala chai ğŸ›â˜•`,
    "Thailand": `pad thai + green curry ğŸŒ¶ï¸ğŸœ`,
    "Turkey": `kebabs + baklava ğŸ¥™ğŸ¯`,
    "Morocco": `tagine + mint tea ğŸ«–ğŸ²`,
    "Ethiopia": `injera + wats ğŸ²`,
    "France": `croissant + cheese ğŸ¥ğŸ§€`,
    "United States": `burgers + BBQ ğŸ”ğŸ”¥`,
    "Australia": `flat white + meat pie + â€œbarbieâ€ culture â˜•ğŸ¥§`
  };

  const FAMOUS_PERSON = {
    "Australia": "Chris Hemsworth (actor) ğŸ¬",
    "New Zealand": "Taika Waititi (filmmaker) ğŸ¬",
    "United States": "BeyoncÃ© (musician) ğŸ¤",
    "Canada": "Ryan Reynolds (actor) ğŸ¬",
    "United Kingdom": "David Bowie (musician) ğŸ¸",
    "France": "Marie Curie (scientist) âš—ï¸",
    "Germany": "Albert Einstein (scientist) ğŸ§ ",
    "Japan": "Hayao Miyazaki (filmmaker) ğŸ¬",
    "India": "Mahatma Gandhi (leader) ğŸ•Šï¸",
    "Brazil": "PelÃ© (athlete) âš½",
    "Mexico": "Frida Kahlo (artist) ğŸ¨",
    "Peru": "Mario Vargas Llosa (writer) ğŸ“š"
  };

  const SYMBOLISM_ONE_LINER = {
    "Peru": "Red honors sacrifice in the independence struggle; white stands for peace/purity.",
    "Iran": "Green/white/red are tied to growth/peace/courage; emblem/pattern reference Islamic identity.",
    "Japan": "Red sun disc represents the sunâ€”Japan as the â€˜land of the rising sun.â€™",
    "France": "Tricolor tied to the Revolution; often read as liberty/equality/fraternity."
  };

  function rjSlugForCountry(name){
    const slug = name.toLowerCase()
      .replace(/â€™/g,'')
      .replace(/'/g,'')
      .replace(/&/g,'and')
      .replace(/[^a-z0-9 ]/g,'')
      .trim()
      .replace(/\s+/g, '-');
    return `https://www.rjtravelagency.com/flag-of-${slug}/`;
  }

  function symbolismBlock(c){
    const name = c.name.common;
    const one = SYMBOLISM_ONE_LINER[name];
    const url = rjSlugForCountry(name);
    return one
      ? `<b>Flag meaning</b>: ${one}`
      : `<b>Flag meaning</b>: Quick reference: <a href="${url}" target="_blank" rel="noopener">RJ Travel Agency</a>.`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles/rice + a signature spice combo ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked magic ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things ğŸ¥©ğŸŒ½",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return [
        `Â· <b>Continent</b>: ${cont} ğŸŒ`,
        `Â· <b>Food</b>: ${hint1Food(c)}`
      ].join('<br/>');
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] || `A person too powerful for this hint engine ğŸ•¶ï¸`;
      return [
        `Â· <b>Famous Name</b>: ${celeb}`,
        `Â· <b>Population</b>: ${pop} ğŸ‘¥`,
        neighborsList(c)
      ].join('<br/>');
    }

    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Â· <b>Rhymes-ish</b>: ${p.words.join(', ')} ğŸ¶`;
    }
    return `Â· <b>Sound clue</b>: ends like â€œ${ends}â€â€¦ try yelling â€œ${ends}!â€ dramatically ğŸ­`;
  }

  function renderFlag() {
    closeSuggest();
    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    renderMsg('neutral','WORLD MAP','', `Type a country name â€” or hit <b>.</b> for a hint (hint uses a try).`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  // Confetti stays as-is from your last rev; leaving unchanged.
  function confettiBurst(ms=3600){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);

    confettiCanvas.width = w;
    confettiCanvas.height = h;

    const ctx = confettiCanvas.getContext('2d');
    const pieces = [];
    const colors = ['#ff6b6b','#ffd93d','#6bcBef','#6bff95','#b36bff','#ff9f43'];

    const count = 220;
    for (let i=0;i<count;i++){
      pieces.push({
        x: Math.random()*w,
        y: -40 - Math.random()*h*0.25,
        vx: (Math.random()*2-1) * dpr * 1.4,
        vy: (Math.random()*1+1.1) * dpr * 1.9,
        r: (Math.random()*4+3) * dpr,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*0.16-0.08),
        c: colors[Math.floor(Math.random()*colors.length)],
        life: Math.random()*0.6 + 0.4
      });
    }

    confettiLayer.style.display = 'block';

    const start = performance.now();
    function tick(t){
      const p = Math.min(1, (t-start)/ms);
      ctx.clearRect(0,0,w,h);

      const fade = Math.max(0, 1 - p);

      for (const s of pieces){
        s.x += s.vx;
        s.y += s.vy;
        s.rot += s.vr;
        s.vy += 0.018 * dpr;
        s.vx *= 0.995;
        s.vy *= 0.998;

        const alpha = Math.max(0, fade * s.life);

        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = s.c;
        ctx.fillRect(-s.r, -s.r, s.r*2.2, s.r*1.2);
        ctx.restore();
      }

      if (p < 1) requestAnimationFrame(tick);
      else confettiLayer.style.display = 'none';
    }
    requestAnimationFrame(tick);
  }

  function roundTransition(nextRoundNumber){
    roundOverlayText.textContent = `ROUND ${nextRoundNumber}!`;
    roundOverlay.style.display = 'grid';
    confettiBurst(3600);

    setTimeout(() => {
      roundOverlay.style.display = 'none';
      renderFlag();
    }, 2600);
  }

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success','TONY TIGER',`ğŸ Game complete! Final score: <b>${score}</b> ğŸ‰`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      updateHUD();
      roundTransition(roundIdx + 1);
      return;
    }

    renderFlag();
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        'FAIL WHALE',
        `Out of tries! Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      'HELPFUL HIPPO',
      `Hint Used (costs a try!)`,
      `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    );
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = currentAcceptedNames(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const emoji = pick(["ğŸ‰","ğŸ¥³","âœ¨"]);
      renderMsg(
        'success',
        'TONY TIGER',
        `Correct! That was <b>${c.name.common}</b>. ${emoji}`,
        `You earned <b>${pts}</b> point${pts === 1 ? '' : 's'}.<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        'FAIL WHALE',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      'FAIL WHALE',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left. (Hit <b>.</b> for a hint â€” it costs a try.)`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'neutral',
      'WORLD MAP',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    renderFlag();
  }

  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }
    return out;
  }

function buildFooter() {
  // --- Position footer so it STARTS AFTER the message box ---
  const footerEl = document.querySelector('.flagFooter');
  const msgRect = belowMsg.getBoundingClientRect();
  const pad = 10; // little breathing room under message box

  // Start AFTER message box (clamped so it doesn't go too high/low)
  const topPx = Math.min(
    Math.max(msgRect.bottom + pad, window.innerHeight * 0.64), // at least lower-ish
    window.innerHeight - 120                                   // never consume entire screen
  );

  footerEl.style.top = `${Math.round(topPx)}px`;
  footerEl.style.height = `${Math.max(0, Math.round(window.innerHeight - topPx))}px`;

  // --- SVG sizing ---
  const w = Math.max(1400, window.innerWidth);
  const h = Math.max(220, Math.round(window.innerHeight - topPx));
  footerSvg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  footerSvg.innerHTML = '';

  const NS = 'http://www.w3.org/2000/svg';
  const defs = document.createElementNS(NS,'defs');

  function makeTemplate(id, drawFn){
    const g = document.createElementNS(NS,'g');
    g.setAttribute('id', id);
    drawFn(g);
    defs.appendChild(g);
  }

  function rect(g, x,y,ww,hh, fill, stroke, sw){
    const r = document.createElementNS(NS,'rect');
    r.setAttribute('x', x); r.setAttribute('y', y);
    r.setAttribute('width', ww); r.setAttribute('height', hh);
    r.setAttribute('rx', 0); r.setAttribute('ry', 0);
    r.setAttribute('fill', fill);
    r.setAttribute('stroke', stroke);
    r.setAttribute('stroke-width', sw);
    g.appendChild(r);
    return r;
  }
  function line(g, x1,y1,x2,y2, stroke, sw){
    const l = document.createElementNS(NS,'line');
    l.setAttribute('x1', x1); l.setAttribute('y1', y1);
    l.setAttribute('x2', x2); l.setAttribute('y2', y2);
    l.setAttribute('stroke', stroke);
    l.setAttribute('stroke-width', sw);
    l.setAttribute('stroke-linecap','round');
    g.appendChild(l);
    return l;
  }
  function circle(g, cx,cy,r, fill, stroke, sw){
    const c = document.createElementNS(NS,'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', r);
    c.setAttribute('fill', fill);
    if (stroke){ c.setAttribute('stroke', stroke); c.setAttribute('stroke-width', sw); }
    g.appendChild(c);
    return c;
  }
  function path(g, d, fill, stroke, sw){
    const p = document.createElementNS(NS,'path');
    p.setAttribute('d', d);
    p.setAttribute('fill', fill);
    if (stroke){ p.setAttribute('stroke', stroke); p.setAttribute('stroke-width', sw); }
    p.setAttribute('stroke-linejoin','round');
    p.setAttribute('stroke-linecap','round');
    g.appendChild(p);
    return p;
  }

  // Lighter + thinner outline
  const strokeOutline = 'rgba(37,48,65,0.32)';
  const strokeThin    = 'rgba(37,48,65,0.22)';
  const paper         = 'rgba(255,255,255,0.92)'; // opaque so occludes properly

  // --- MORE VARIETY of simplified flag archetypes ---
  makeTemplate('tpl-tri-vert', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    line(g,14.7,0,14.7,26,strokeThin,1.0);
    line(g,29.3,0,29.3,26,strokeThin,1.0);
  });

  makeTemplate('tpl-tri-horz', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    line(g,0,8.7,44,8.7,strokeThin,1.0);
    line(g,0,17.4,44,17.4,strokeThin,1.0);
  });

  makeTemplate('tpl-nordic', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    line(g,0,13,44,13,'rgba(37,48,65,0.20)',1.6);
    line(g,16,0,16,26,'rgba(37,48,65,0.20)',1.6);
  });

  makeTemplate('tpl-sun', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    circle(g,22,13,7,'rgba(255,255,255,0.0)','rgba(37,48,65,0.22)',1.3);
  });

  makeTemplate('tpl-diag', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    path(g,'M0 24 L0 20 L40 0 L44 0 L44 6 L6 26 L0 26 Z','rgba(0,0,0,0)','rgba(37,48,65,0.20)',1.2);
  });

  makeTemplate('tpl-canton', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    rect(g,0,0,18,14,'rgba(255,255,255,0.0)',strokeThin,1.0);
    for (let y=5;y<=25;y+=5) line(g,0,y,44,y,strokeThin,0.9);
  });

  makeTemplate('tpl-diamond', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    path(g,'M22 3 L39 13 L22 23 L5 13 Z','rgba(255,255,255,0.0)','rgba(37,48,65,0.20)',1.2);
    circle(g,22,13,5,'rgba(255,255,255,0.0)','rgba(37,48,65,0.18)',1.0);
  });

  makeTemplate('tpl-star', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    // little star-ish asterisk
    line(g,22,7,22,19,'rgba(37,48,65,0.20)',1.1);
    line(g,17,13,27,13,'rgba(37,48,65,0.20)',1.1);
    line(g,18.5,9.5,25.5,16.5,'rgba(37,48,65,0.20)',1.0);
    line(g,25.5,9.5,18.5,16.5,'rgba(37,48,65,0.20)',1.0);
  });

  makeTemplate('tpl-crescent', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    // crescent via two circles outline
    circle(g,22,13,7,'rgba(255,255,255,0.0)','rgba(37,48,65,0.20)',1.1);
    circle(g,25,13,6,'rgba(255,255,255,0.92)','rgba(0,0,0,0)',0);
    circle(g,31,11,1.4,'rgba(255,255,255,0.0)','rgba(37,48,65,0.20)',1.0);
  });

  makeTemplate('tpl-plus', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    line(g,0,13,44,13,'rgba(37,48,65,0.20)',1.4);
    line(g,22,0,22,26,'rgba(37,48,65,0.20)',1.4);
  });

  makeTemplate('tpl-bars-5', (g)=>{
    rect(g,0,0,44,26,paper,strokeOutline,1.0);
    for (let y=4;y<=22;y+=4.6) line(g,0,y,44,y,'rgba(37,48,65,0.18)',0.95);
  });

  footerSvg.appendChild(defs);

  const templates = [
    'tpl-tri-vert','tpl-tri-horz','tpl-nordic','tpl-sun','tpl-diag',
    'tpl-canton','tpl-diamond','tpl-star','tpl-crescent','tpl-plus','tpl-bars-5'
  ];

  // --- Density tuning: a bit LESS dense, still "pile" vibe ---
  const flagW = 45;
  const flagH = 26;
  const scaleBase = flagW / 44;

  const padX = 14;
  const padY = 10;

  // Increase spacing slightly (less dense) + smaller overlap
  const cellW = flagW * 0.98;
  const cellH = flagH * 0.98;

  const cols = Math.max(10, Math.floor((w - padX*2) / cellW));
  const rows = Math.max(6, Math.floor((h - padY*2) / cellH));

  // Generate jittered grid, then keep lower portion for "mountain"
  const points = [];
  for (let r = 0; r < rows; r++){
    for (let c = 0; c < cols; c++){
      const yBase = padY + r * cellH;
      const xBase = padX + c * cellW;

      const jx = (Math.random()*0.9 - 0.45) * (cellW * 0.55);
      const jy = (Math.random()*0.9 - 0.45) * (cellH * 0.55);

      points.push({ x: xBase + jx, y: yBase + jy });
    }
  }

  points.sort((a,b)=> a.y - b.y);

  // Start lower inside the footer area (no "creeping up")
  const keepStart = Math.floor(points.length * 0.22);
  const keep = points.slice(keepStart);

  // Lightly boost bottom density (NOT crazy), with tiny offsets
  const extra = [];
  for (let i = Math.floor(keep.length*0.70); i < keep.length; i += 4){
    const p = keep[i];
    extra.push({ x: p.x + (Math.random()*5-2.5), y: p.y + (Math.random()*5-2.5) });
  }
  const all = keep.concat(extra);

  // Color: randomly color ~10% of ALL items, but make them more prominent
  const coloredCount = Math.max(1, Math.floor(all.length * 0.10));
  const coloredIdx = new Set();
  while (coloredIdx.size < coloredCount) coloredIdx.add(Math.floor(Math.random() * all.length));

  function randColor(i){
    const hh = (i * 137.508) % 360;
    // more prominent (less washed out than before)
    return `hsla(${hh}, 62%, 56%, 0.92)`;
  }

  // Draw top-to-bottom for occlusion (later = on top)
  const items = all.map((p, i) => {
    const id = templates[Math.floor(Math.random() * templates.length)];
    const useColored = coloredIdx.has(i);
    const rot = (Math.random() * 10 - 5);
    const scale = scaleBase * (0.98 + Math.random() * 0.22);
    return { i, id, useColored, x: p.x, y: p.y, rot, scale };
  });

  items.sort((a,b)=> a.y - b.y);

  for (const it of items) {
    const g = document.createElementNS(NS,'g');
    g.setAttribute('transform', `translate(${it.x},${it.y}) rotate(${it.rot}) scale(${it.scale})`);

    // Paper base ALWAYS (opaque)
    rect(g,0,0,44,26,paper,'rgba(0,0,0,0)',0);

    // Color wash on top of paper for â€œprominent colorâ€
    if (it.useColored) {
      rect(g,0,0,44,26,randColor(it.i),'rgba(0,0,0,0)',0);
    }

    const use = document.createElementNS(NS,'use');
    use.setAttribute('href', `#${it.id}`);
    g.appendChild(use);

    footerSvg.appendChild(g);
  }
}

  // Events
  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', () => { restart(); buildFooter(); });

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => { if (guessInput.value) renderSuggestions(guessInput.value); });

  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }
    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        applySuggestionSelectionToInput();
      }
      submitGuess();
      return;
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== '.') return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;
    const t = e.target;
    const isTextField = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') && !t.readOnly && !t.disabled;
    if (isTextField) e.preventDefault();
    consumeTryWithHint();
    guessInput.focus();
  });

  // Boot
  async function loadCountries() {
    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);
    buildFooter();
    restart();
  }

  loadCountries().catch(err => {
    console.error(err);
    renderMsg('fail','FAIL WHALE',`Couldnâ€™t load country data.`, `${String(err.message || err)}`);
  });

  window.addEventListener('resize', () => buildFooter());
})();
</script>
</body>
</html>
