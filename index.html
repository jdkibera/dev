<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kibera's Flag Gauntlet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Calligraffitti&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #dfe8f4;
      --ink: #253041;
      --card: rgba(11,16,32,0.92);
      --cardBorder: rgba(0,0,0,0.18);

      --pillBg: rgba(255,255,255,0.10);

      --flagStageH: 340px;

      /* Messaging area: fixed layout so nothing jumps */
      --msgH: 320px;
      --iconColW: 150px;

      --brandBlueGrey: rgba(80, 110, 140, 0.42);

      /* --- Comic burst + fonts --- */
      --burstOutline: rgba(0,0,0,0.88);
      --burstShadow: rgba(0,0,0,0.30);
      --burstDot: rgba(0,0,0,0.26);
      --burstTextShadow: rgba(0,0,0,0.18);
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* =============================================================================================
       SECTION: FONT LOADING (BAZINGA)
       - NOTE: Place a Bazinga webfont at /fonts/Bazinga.woff2 (or adjust URL below).
       ============================================================================================= */
    @font-face{
      font-family: "Bazinga";
      src: url("./fonts/Bazinga.woff2") format("woff2");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    .main{
      flex: 1;
      display: grid;
      place-items: center;
      padding: 70px 14px 10px;
      position: relative;
      z-index: 2;
    }

    .wrap{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    .brandAngle{
      position: absolute;
      left: -132px;
      top: 118px;
      transform: rotate(-45deg);
      transform-origin: left top;
      font-family: "Calligraffitti", "Snell Roundhand", "Apple Chancery", "Segoe Script", cursive;
      font-size: 46px;
      font-weight: 400;
      color: var(--brandBlueGrey);
      user-select: none;
      pointer-events: none;
      z-index: 10;
      line-height: 0.92;
      text-align: center;
      width: 250px;
    }

    .topbar{
      width: min(900px, 100%);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }

    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--pillBg);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 18px;
      color: #0b1020;
      display:flex;
      align-items:center;
      gap: 10px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .pill b{ font-size: 20px; }

    .restartBtnTop{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      color: #0b1020;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      letter-spacing: 0.8px;
      font-weight: 900;
    }
    .restartBtnTop:hover{ background: rgba(0,0,0,0.10); }

    .card{
      width: min(900px, 100%);
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px 18px 16px;
      color: #e9eefc;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
      position: relative;
    }

    .questionTitle{
      text-align: center;
      margin: 6px 0 10px;
      font-size: 34px;
      letter-spacing: 0.3px;
      font-weight: 200;
      opacity: 0.95;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    .flagStage{
      height: var(--flagStageH);
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 12px;
      box-sizing: border-box;
    }
    .flag{
      width: min(520px, 92%);
      max-height: calc(var(--flagStageH) - 18px);
      object-fit: contain;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }

    .controls{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 0px;
    }
    .controlRow{
      width: min(520px, 92%);
      display:flex;
      align-items: stretch;
      gap: 10px;
    }

    .inputWrap{ flex: 1; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,0.65); }

    .btnCol{
      display:flex;
      gap: 10px;
      align-items: stretch;
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(90,140,255,0.22);
      color: #e9eefc;
      cursor: pointer;
      min-width: 96px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 0.9px;
    }
    button:hover{ background: rgba(90,140,255,0.33); }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    /* Hint CTA: shown ONLY here (kept); requested copy */
    .hintHotkeyLine{
      width: min(520px, 92%);
      text-align: left;
      font-size: 15px; /* ~15% larger than 13px */
      color: rgba(233,238,252,0.76);
      margin-top: -2px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .hintHotkeyLine b{ color: rgba(233,238,252,0.92); font-weight: 650; }

    .suggestBox{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 8px);
      background: rgba(14, 20, 40, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      overflow: hidden;
      z-index: 50;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .sgItem{
      padding: 10px 12px;
      cursor: pointer;
      color: #e9eefc;
      border-top: 1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .sgItem:hover, .sgItem.active{ background: rgba(90,140,255,0.22); }
    .sgMeta{ font-size: 12px; opacity: 0.70; white-space: nowrap; }

    /* Messaging area: fixed layout so nothing jumps */
    .belowMsg{
      width: min(900px, 100%);
      height: var(--msgH);
      display: grid;
      place-items: center;
      overflow: hidden;
      z-index: 2;
      position: relative;
    }

    .msgGrid{
      width: min(900px, 100%);
      display: grid;
      grid-template-columns: var(--iconColW) minmax(0, 1fr);
      align-items: start;
      gap: 18px;
      padding: 0 6px;
      box-sizing: border-box;
    }

    .iconCol{
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding-top: 2px;
    }

    .iconSq{
      width: 132px;
      height: 132px;
      border-radius: 18px;
      border: none;
      background: rgba(255,255,255,0.0);
      overflow: visible;
      display: grid;
      place-items: center;
      box-shadow: none;
    }
    .iconSq svg{
      width: 132px;
      height: 132px;
      display:block;
    }

    /* Messaging typography */
    .msgText{
      text-align: left;
      line-height: 1.25;
      align-self: start;
      padding-top: 6px;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }
    .msgText .headline{
      font-size: 29px;
      margin: 0 0 10px;
      min-height: 36px;
      color: rgba(37,48,65,0.92);
      font-weight: 320;
    }
    .msgText .sub{
      font-size: 22px;
      opacity: 0.92;
      margin: 0;
      min-height: 96px;
      color: rgba(37,48,65,0.86);
      font-weight: 300;
    }
    /* Requested: bold lighter weight (Continent, Food etc.) */
    .msgText b{ font-weight: 520; }
    .msgText a{
      color: rgba(30,80,170,0.95);
      text-decoration: underline;
      font-weight: 520;
    }

    .bottomArea{
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .copyright{
      position: fixed;
      left: 0;
      width: 100%;
      bottom: 50px;
      text-align: center;
      color: rgba(37,48,65,0.75);
      font-size: 13px;
      letter-spacing: 0.3px;
      z-index: 3;
      pointer-events: none;
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      font-weight: 300;
    }

    /* =============================================================================================
       SECTION: HEADER + FOOTER FLAG BANDS (SVG)
       - Footer: fades IN as you move down.
       - Header: solid at top, fades OUT as you move down into the page.
       ============================================================================================= */

    .flagHeader{
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 210px;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .headerSvg{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 1;

      /* solid at top -> transparent toward bottom (fade OUT into bg) */
      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,1.00) 0%,
        rgba(0,0,0,1.00) 40%,
        rgba(0,0,0,0.65) 62%,
        rgba(0,0,0,0.25) 80%,
        rgba(0,0,0,0.00) 100%
      );
    }

    /* Footer begins AFTER message box (JS sets top/height). Fades in from that point. */
    .flagFooter{
      position: fixed;
      left: 0;
      width: 100vw;
      bottom: 0;
      top: auto;           /* JS will set top */
      height: 0px;         /* JS will set height */
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      background: none;
    }
    .footerSvg{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      opacity: 1;

      /* fade-in AFTER the message box: top is transparent -> visible below */
      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0.00) 0%,
        rgba(0,0,0,0.00) 12%,
        rgba(0,0,0,0.35) 28%,
        rgba(0,0,0,1.00) 55%,
        rgba(0,0,0,1.00) 100%
      );
    }

    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    .roundOverlay{
      position: fixed;
      inset: 0;
      display: none;
      pointer-events: none;
      z-index: 10000;
      place-items: center;
      text-align: center;
    }
    .roundOverlay .big{
      font-family: "Bazinga", "Bangers", "Impact", system-ui, sans-serif;
      font-weight: 400;
      font-size: min(170px, 18vw);
      line-height: 0.95;
      color: rgba(0,0,0,0.0);
      padding: 0;
      border-radius: 0;
      background: transparent;
      border: none;
      text-shadow: none;
    }

    @media (max-width: 900px){
      .brandAngle{ left: -122px; top: 130px; font-size: 40px; width: 230px; }
      .questionTitle{ font-size: 30px; }
      .iconSq{ width: 120px; height: 120px; }
      :root{ --iconColW: 140px; --msgH: 300px; }
      .msgText .headline{ font-size: 26px; }
      .msgText .sub{ font-size: 20px; }
      .flagHeader{ height: 190px; }
    }
    @media (max-width: 760px){
      :root{ --iconColW: 132px; --msgH: 290px; }
      .pill{ font-size: 16px; }
      .pill b{ font-size: 18px; }
      .questionTitle{ font-size: 26px; }
      .brandAngle{ font-size: 34px; left: -110px; top: 140px; width: 210px; }
      .flagHeader{ height: 175px; }
    }
  </style>
</head>

<body>
  <div class="confettiLayer" id="confettiLayer">
    <canvas id="confettiCanvas" style="width:100%;height:100%"></canvas>
  </div>

  <div class="roundOverlay" id="roundOverlay">
    <div class="big" id="roundOverlayText"></div>
  </div>

  <!-- Header flags (mirror/invert of footer logic; same drawing code, different mask) -->
  <div class="flagHeader" aria-hidden="true">
    <svg id="headerSvg" class="headerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
  </div>

  <div class="main">
    <div class="wrap">
      <div class="brandAngle">Kibera's<br/>Flag Gauntlet</div>

      <div class="topbar">
        <div class="pill">Round: <b id="roundNum">1</b> / <span id="roundTotal">?</span></div>
        <div class="pill">Flag: <b id="flagIndex">1</b> / <b id="flagsPerRound">10</b></div>
        <div class="pill">Tries left: <b id="triesLeft">3</b></div>
        <div class="pill">
          Score: <b id="score">0</b>
          <button class="restartBtnTop" id="restartBtnTop" title="Restart from Round 1">RESTART</button>
        </div>
      </div>

      <div class="card" id="card">
        <div class="questionTitle">What Country's Flag Is This?</div>

        <div class="flagStage">
          <img id="flagImg" class="flag" alt="Country flag" />
        </div>

        <div class="controls">
          <div class="controlRow">
            <div class="inputWrap">
              <input id="guessInput" type="text" placeholder="Type a country nameâ€¦" autocomplete="off" />
              <div id="suggestBox" class="suggestBox" role="listbox" aria-label="Country suggestions"></div>
            </div>

            <div class="btnCol">
              <button id="submitBtn">SUBMIT</button>
              <button id="skipBtn" title="Give up on this flag (0 points)">SKIP</button>
            </div>
          </div>

          <div class="hintHotkeyLine">
            Hit the period <b>&ldquo;.&rdquo;</b> key for a hint! Each hint costs a try
          </div>
        </div>
      </div>

      <div class="belowMsg" id="belowMsg"></div>
    </div>
  </div>

  <div class="bottomArea">
    <div class="copyright">Â© 2026 Kibera &amp; Co.</div>
    <div class="flagFooter" aria-hidden="true">
      <svg id="footerSvg" class="footerSvg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>
    </div>
  </div>

<script>
(() => {
  const FLAGS_PER_ROUND = 10;
  const TRIES_PER_FLAG = 3;

  const PAUSE_CORRECT_MS = 3000;
  const PAUSE_WRONG_MS   = 10000;

  // UI
  const roundNumEl = document.getElementById('roundNum');
  const roundTotalEl = document.getElementById('roundTotal');
  const flagIndexEl = document.getElementById('flagIndex');
  const flagsPerRoundEl = document.getElementById('flagsPerRound');
  const triesLeftEl = document.getElementById('triesLeft');
  const scoreEl = document.getElementById('score');

  const flagImg = document.getElementById('flagImg');
  const guessInput = document.getElementById('guessInput');
  const submitBtn = document.getElementById('submitBtn');
  const skipBtn = document.getElementById('skipBtn');
  const restartBtnTop = document.getElementById('restartBtnTop');

  const suggestBox = document.getElementById('suggestBox');
  const belowMsg = document.getElementById('belowMsg');

  const footerSvg = document.getElementById('footerSvg');
  const headerSvg = document.getElementById('headerSvg');

  const confettiLayer = document.getElementById('confettiLayer');
  const confettiCanvas = document.getElementById('confettiCanvas');
  const roundOverlay = document.getElementById('roundOverlay');
  const roundOverlayText = document.getElementById('roundOverlayText');

  // Game state
  let countries = [];
  let rounds = [];
  let roundIdx = 0;
  let flagIdx = 0;
  let triesLeft = TRIES_PER_FLAG;
  let score = 0;

  // Suggest state
  let activeSuggestionIndex = -1;
  let currentSuggestions = [];
  let lastRenderedQuery = "";

  let cca3ToCountry = new Map();

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function norm(s) {
    return String(s || '')
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9 ]/g, '')
      .replace(/\s+/g, ' ');
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function updateHUD() {
    roundNumEl.textContent = String(roundIdx + 1);
    roundTotalEl.textContent = String(rounds.length || '?');
    flagIndexEl.textContent = String(flagIdx + 1);
    flagsPerRoundEl.textContent = String(FLAGS_PER_ROUND);
    triesLeftEl.textContent = String(triesLeft);
    scoreEl.textContent = String(score);
  }

  function currentCountry() {
    return rounds?.[roundIdx]?.[flagIdx] || null;
  }

  function continentLabel(region, subregion) {
    const r = String(region || '').trim();
    const s = String(subregion || '').trim();
    if (!r) return 'Other';
    if (r === 'Americas') {
      if (s.includes('South')) return 'South America';
      if (s.includes('North')) return 'North America';
      if (s.includes('Caribbean')) return 'Caribbean';
      if (s.includes('Central')) return 'Central America';
      return 'Americas';
    }
    return r;
  }

  /* =============================================================================================
     SECTION: ICONS / COMIC BURSTS (TRANSPARENT BACKGROUND)
     - Uses Bazinga font (via @font-face).
     - Transparent background (no fill behind burst).
     - Burst closer to referenced halftone comic bubble feel.
     ============================================================================================= */

  function burstSVG(kind, word) {
    // Color presets requested:
    // default ("Let's Go!") -> green text, burst darker green + light green/yellow
    // fail ("Oh Nawr!") -> yellow text, burst red/orange
    // success ("Boom!") -> light blue text, burst red/orange
    // hint ("Pssst!") -> light blue text, burst blue/purple

    let textFill = "#38d27b";
    let burstA = "#1b7a40";
    let burstB = "#b7f27b";
    let burstC = "#ffd65a";

    if (kind === 'fail') {
      textFill = "#ffe45b";
      burstA = "#ff3a2e";
      burstB = "#ff9b3d";
      burstC = "#ffd65a";
    } else if (kind === 'success') {
      textFill = "#8dd7ff";
      burstA = "#ff3a2e";
      burstB = "#ff9b3d";
      burstC = "#ffd65a";
    } else if (kind === 'hint') {
      textFill = "#8dd7ff";
      burstA = "#5b44ff";
      burstB = "#8a6bff";
      burstC = "#ff6ad6";
    } else if (kind === 'neutral') {
      // Default message bubble: keep "Let's Go!" look (green)
      textFill = "#38d27b";
      burstA = "#1b7a40";
      burstB = "#b7f27b";
      burstC = "#ffd65a";
    }

    // Thinner outline (requested: reduce outline weight by 50% vs prior)
    const outline = "rgba(0,0,0,0.88)";
    const outlineW = 2.2;

    // A more "real" jagged burst (hand-tuned)
    const burstPathOuter =
      "M66 8 L78 20 L94 14 L90 32 L108 38 L92 50 L110 62 L90 68 L96 86 L78 78 L66 96 L58 80 L40 96 L42 78 L20 86 L26 68 L6 62 L24 50 L8 38 L26 32 L22 14 L40 20 L50 8 L58 24 Z";
    const burstPathInner =
      "M66 18 L74 26 L86 22 L84 34 L98 38 L86 46 L98 56 L84 58 L88 72 L74 66 L66 78 L60 66 L48 78 L50 66 L36 72 L40 58 L26 56 L38 46 L26 38 L40 34 L38 22 L48 26 L56 18 L60 30 Z";

    // Halftone dots clipped to outer burst-ish region (no background fill)
    return `
      <svg viewBox="0 0 116 104" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <pattern id="dotPat" width="8" height="8" patternUnits="userSpaceOnUse">
            <circle cx="2" cy="2" r="1.4" fill="rgba(0,0,0,0.22)"></circle>
          </pattern>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="1.2" flood-color="rgba(0,0,0,0.22)"/>
          </filter>
        </defs>

        <g filter="url(#softShadow)">
          <path d="${burstPathOuter}" fill="${burstA}" stroke="${outline}" stroke-width="${outlineW}" stroke-linejoin="round"/>
          <path d="${burstPathInner}" fill="${burstB}" stroke="${outline}" stroke-width="${outlineW * 0.85}" stroke-linejoin="round" opacity="0.95"/>
          <path d="${burstPathInner}" fill="url(#dotPat)" opacity="0.55"/>
          <path d="${burstPathInner}" fill="${burstC}" opacity="0.20"/>

          <text x="58" y="58"
            text-anchor="middle"
            dominant-baseline="middle"
            font-family="Bazinga, Bangers, Impact, system-ui, sans-serif"
            font-size="30"
            fill="${textFill}"
            stroke="${outline}"
            stroke-width="2.6"
            paint-order="stroke"
            style="letter-spacing: 1px;"
          >${String(word || '').toUpperCase()}</text>
        </g>
      </svg>
    `;
  }

  function renderMsg(kind, headline, sub){
    // No extra all-caps labels; just burst + text.
    let burstWord = "LET'S GO!";
    if (kind === 'fail') burstWord = "OH NAWR!";
    if (kind === 'success') burstWord = "BOOM!";
    if (kind === 'hint') burstWord = "PSSSST!";
    if (kind === 'neutral') burstWord = "LET'S GO!";

    belowMsg.innerHTML = `
      <div class="msgGrid">
        <div class="iconCol">
          <div class="iconSq" aria-hidden="true">${burstSVG(kind, burstWord)}</div>
        </div>
        <div class="msgText">
          <div class="headline">${headline || ""}</div>
          <div class="sub">${sub || ""}</div>
        </div>
      </div>
    `;
  }

  /* =============================================================================================
     SECTION: SUGGESTIONS (UNCHANGED)
     ============================================================================================= */

  function closeSuggest() {
    suggestBox.style.display = 'none';
    suggestBox.innerHTML = '';
    activeSuggestionIndex = -1;
    currentSuggestions = [];
    lastRenderedQuery = "";
  }

  function openSuggest() { suggestBox.style.display = 'block'; }

  function renderSuggestions(query) {
    const q = norm(query);
    if (!q) { closeSuggest(); return; }
    if (q === lastRenderedQuery) return;

    const matches = countries
      .filter(c => norm(c.name.common).startsWith(q))
      .slice(0, 25);

    if (!matches.length) { closeSuggest(); return; }

    suggestBox.innerHTML = '';
    currentSuggestions = matches.map(c => ({
      name: c.name.common,
      continent: continentLabel(c.region, c.subregion)
    }));

    activeSuggestionIndex = 0;

    currentSuggestions.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sgItem' + (idx === 0 ? ' active' : '');
      row.innerHTML = `<span>${it.name}</span><span class="sgMeta">${it.continent}</span>`;
      row.addEventListener('mousedown', (e) => {
        e.preventDefault();
        guessInput.value = it.name;
        closeSuggest();
        guessInput.focus();
      });
      suggestBox.appendChild(row);
    });

    lastRenderedQuery = q;
    openSuggest();
  }

  function moveActive(delta) {
    if (suggestBox.style.display !== 'block') return;
    if (!currentSuggestions.length) return;

    activeSuggestionIndex += delta;
    if (activeSuggestionIndex < 0) activeSuggestionIndex = currentSuggestions.length - 1;
    if (activeSuggestionIndex >= currentSuggestions.length) activeSuggestionIndex = 0;

    [...suggestBox.querySelectorAll('.sgItem')].forEach((el, idx) => {
      el.classList.toggle('active', idx === activeSuggestionIndex);
    });

    const activeEl = suggestBox.querySelectorAll('.sgItem')[activeSuggestionIndex];
    if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
  }

  function applySuggestionSelectionToInput() {
    if (suggestBox.style.display !== 'block') return false;
    if (!currentSuggestions.length) return false;

    const idx = Math.max(0, activeSuggestionIndex);
    const pickItem = currentSuggestions[idx] || currentSuggestions[0];
    if (pickItem?.name) {
      guessInput.value = pickItem.name;
      closeSuggest();
      return true;
    }
    return false;
  }

  function currentAcceptedNames(c) {
    const accepted = new Set();
    accepted.add(norm(c.name?.common));
    accepted.add(norm(c.name?.official));
    (c.altSpellings || []).forEach(s => accepted.add(norm(s)));

    const common = norm(c.name?.common);
    if (common === 'united states') accepted.add('usa');
    if (common === 'united kingdom') accepted.add('uk');
    if (common === 'russia') accepted.add('russian federation');
    if (common === 'south korea') accepted.add('korea');
    if (common === 'czechia') accepted.add('czech republic');
    return accepted;
  }

  function fmtNumber(n){
    if (!Number.isFinite(n)) return 'â€”';
    return n.toLocaleString('en-US');
  }

  function neighborsList(c){
    const borders = Array.isArray(c.borders) ? c.borders : [];
    const names = borders
      .map(code => cca3ToCountry.get(code)?.name?.common)
      .filter(Boolean);

    if (!names.length) return `Â· <b>Neighbors</b>: <b>none</b> (island / solo mode) ğŸï¸`;

    const sample = names.slice(0, 6);
    const extra = names.length > sample.length ? ` (+${names.length - sample.length} more)` : '';
    return `Â· <b>Neighbors</b>: ${sample.join(', ')}${extra} ğŸ¤`;
  }

  const FOOD_HINT = {
    "Iran": `date palms & saffron rice with meat (Chelo Kabab) ğŸšğŸ¥©`,
    "Peru": `ceviche + lomo saltado ğŸŸğŸ¥”`,
    "Japan": `sushi + ramen ğŸ£ğŸœ`,
    "Italy": `pasta + espresso ğŸâ˜•`,
    "Mexico": `tacos al pastor + mole ğŸŒ®ğŸ«`,
    "India": `biryani + masala chai ğŸ›â˜•`,
    "Thailand": `pad thai + green curry ğŸŒ¶ï¸ğŸœ`,
    "Turkey": `kebabs + baklava ğŸ¥™ğŸ¯`,
    "Morocco": `tagine + mint tea ğŸ«–ğŸ²`,
    "Ethiopia": `injera + wats ğŸ²`,
    "France": `croissant + cheese ğŸ¥ğŸ§€`,
    "United States": `burgers + BBQ ğŸ”ğŸ”¥`,
    "Australia": `flat white + meat pie + â€œbarbieâ€ culture â˜•ğŸ¥§`
  };

  const FAMOUS_PERSON = {
    "Australia": "Chris Hemsworth (actor) ğŸ¬",
    "New Zealand": "Taika Waititi (filmmaker) ğŸ¬",
    "United States": "BeyoncÃ© (musician) ğŸ¤",
    "Canada": "Ryan Reynolds (actor) ğŸ¬",
    "United Kingdom": "David Bowie (musician) ğŸ¸",
    "France": "Marie Curie (scientist) âš—ï¸",
    "Germany": "Albert Einstein (scientist) ğŸ§ ",
    "Japan": "Hayao Miyazaki (filmmaker) ğŸ¬",
    "India": "Mahatma Gandhi (leader) ğŸ•Šï¸",
    "Brazil": "PelÃ© (athlete) âš½",
    "Mexico": "Frida Kahlo (artist) ğŸ¨",
    "Peru": "Mario Vargas Llosa (writer) ğŸ“š"
  };

  const SYMBOLISM_ONE_LINER = {
    "Peru": "Red honors sacrifice in the independence struggle; white stands for peace/purity.",
    "Iran": "Green/white/red are tied to growth/peace/courage; emblem/pattern reference Islamic identity.",
    "Japan": "Red sun disc represents the sunâ€”Japan as the â€˜land of the rising sun.â€™",
    "France": "Tricolor tied to the Revolution; often read as liberty/equality/fraternity."
  };

  function rjSlugForCountry(name){
    const slug = name.toLowerCase()
      .replace(/â€™/g,'')
      .replace(/'/g,'')
      .replace(/&/g,'and')
      .replace(/[^a-z0-9 ]/g,'')
      .trim()
      .replace(/\s+/g, '-');
    return `https://www.rjtravelagency.com/flag-of-${slug}/`;
  }

  function symbolismBlock(c){
    const name = c.name.common;
    const one = SYMBOLISM_ONE_LINER[name];
    const url = rjSlugForCountry(name);
    return one
      ? `<b>Flag meaning</b>: ${one}`
      : `â„¹ï¸ <a href="${url}" target="_blank" rel="noopener">Learn more about this flag</a>`;
  }

  function hint1Food(c){
    const name = c.name.common;
    if (FOOD_HINT[name]) return FOOD_HINT[name];

    const cont = continentLabel(c.region, c.subregion);
    const fallback = {
      "Europe": "cheese + bread + something fermented ğŸ§€ğŸ¥–",
      "Asia": "noodles/rice + a signature spice combo ğŸœğŸš",
      "Africa": "stews + grains + slow-cooked magic ğŸ²",
      "North America": "BBQ or tacosâ€¦ possibly both ğŸ”¥ğŸŒ®",
      "Central America": "beans + rice + coffee fuel â˜•ğŸ›",
      "Caribbean": "jerk seasoning + tropical fruit ğŸ¥­ğŸŒ¶ï¸",
      "South America": "grilled meats + corn things ğŸ¥©ğŸŒ½",
      "Oceania": "BBQ + beach picnic energy ğŸ–ï¸ğŸ¥©",
      "Other": "mystery snacks from a parallel universe ğŸ¥ªğŸ§"
    };
    return fallback[cont] || fallback["Other"];
  }

  function hintForTry(c, tryUsed){
    if (tryUsed === 1) {
      const cont = continentLabel(c.region, c.subregion);
      return [
        `Â· <b>Continent</b>: ${cont} ğŸŒ`,
        `Â· <b>Food</b>: ${hint1Food(c)}`
      ].join('<br/>');
    }
    if (tryUsed === 2) {
      const pop = fmtNumber(Math.round(c.population || 0));
      const celeb = FAMOUS_PERSON[c.name.common] || `A person too powerful for this hint engine ğŸ•¶ï¸`;
      return [
        `Â· <b>Famous Name</b>: ${celeb}`,
        `Â· <b>Population</b>: ${pop} ğŸ‘¥`,
        neighborsList(c)
      ].join('<br/>');
    }

    const name = c.name.common;
    const n = norm(name).replace(/ /g,'');
    const ends = n.slice(-3);
    const patterns = [
      { suffix: 'land', words: ['sand','hand','band','grand'] },
      { suffix: 'ia', words: ['see-ya','pizzeria','utopia','chia'] },
      { suffix: 'stan', words: ['plan','fan','can','pan'] },
      { suffix: 'ana', words: ['banana','cabana','bandana','nirvana'] },
      { suffix: 'ine', words: ['wine','fine','line','shine'] },
    ];
    for (const p of patterns){
      if (n.endsWith(p.suffix)) return `Â· <b>Rhymes-ish</b>: ${p.words.join(', ')} ğŸ¶`;
    }
    return `Â· <b>Sound clue</b>: ends like â€œ${ends}â€â€¦ try yelling â€œ${ends}!â€ dramatically ğŸ­`;
  }

  function renderFlag() {
    closeSuggest();
    const c = currentCountry();
    if (!c) return;

    const url = c.flags?.png || c.flags?.svg || '';
    flagImg.src = url;
    flagImg.alt = `Flag of ${c.name?.common || 'Unknown'}`;

    triesLeft = TRIES_PER_FLAG;
    guessInput.value = '';
    guessInput.focus();
    updateHUD();

    // IMPORTANT: only hint CTA is under input; keep this neutral text simple (no hint CTA repeat)
    renderMsg('neutral','', `Type a country name.`);
  }

  function pointsForTry(tryNumberUsed) {
    if (tryNumberUsed === 1) return 3;
    if (tryNumberUsed === 2) return 2;
    if (tryNumberUsed === 3) return 1;
    return 0;
  }

  /* =============================================================================================
     SECTION: CONFETTI + ROUND OVERLAY
     - Confetti: more volume, 3s fall.
     - Round overlay: comic burst growth from vanishing point.
     ============================================================================================= */

  function confettiBurst(ms=3000){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);

    confettiCanvas.width = w;
    confettiCanvas.height = h;

    const ctx = confettiCanvas.getContext('2d');
    const pieces = [];
    const colors = ['#ff6b6b','#ffd93d','#6bcBef','#6bff95','#b36bff','#ff9f43'];

    const count = 520; // more volume
    for (let i=0;i<count;i++){
      pieces.push({
        x: Math.random()*w,
        y: -60 - Math.random()*h*0.35,
        vx: (Math.random()*2-1) * dpr * 2.0,
        vy: (Math.random()*1+1.2) * dpr * 2.6,
        r: (Math.random()*4+3) * dpr,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*0.18-0.09),
        c: colors[Math.floor(Math.random()*colors.length)],
        life: Math.random()*0.7 + 0.3
      });
    }

    confettiLayer.style.display = 'block';

    const start = performance.now();
    function tick(t){
      const p = Math.min(1, (t-start)/ms);
      ctx.clearRect(0,0,w,h);

      const fade = Math.max(0, 1 - p);

      for (const s of pieces){
        s.x += s.vx;
        s.y += s.vy;
        s.rot += s.vr;
        s.vy += 0.028 * dpr;
        s.vx *= 0.992;
        s.vy *= 0.996;

        const alpha = Math.max(0, fade * s.life);

        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = s.c;
        ctx.fillRect(-s.r, -s.r, s.r*2.4, s.r*1.3);
        ctx.restore();
      }

      if (p < 1) requestAnimationFrame(tick);
      else confettiLayer.style.display = 'none';
    }
    requestAnimationFrame(tick);
  }

  function roundBurstSVG(text){
    // Big center burst (transparent background)
    return `
      <svg viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="dotBig" width="16" height="16" patternUnits="userSpaceOnUse">
            <circle cx="4" cy="4" r="2.5" fill="rgba(0,0,0,0.24)"></circle>
          </pattern>
          <filter id="drop" x="-30%" y="-30%" width="160%" height="160%">
            <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(0,0,0,0.25)"/>
          </filter>
        </defs>

        <g filter="url(#drop)" transform="translate(600 350)">
          <path d="M0 -280 L80 -200 L220 -240 L180 -120 L310 -80 L190 0 L320 90 L180 120 L220 250 L80 200 L0 280 L-70 200 L-220 250 L-180 120 L-310 90 L-190 0 L-310 -80 L-180 -120 L-220 -240 L-70 -200 Z"
                fill="#ff3a2e" stroke="rgba(0,0,0,0.9)" stroke-width="10" stroke-linejoin="round"/>
          <path d="M0 -220 L70 -160 L170 -185 L145 -95 L235 -65 L150 0 L240 75 L145 95 L170 190 L70 160 L0 220 L-60 160 L-170 190 L-145 95 L-235 75 L-150 0 L-235 -65 L-145 -95 L-170 -185 L-60 -160 Z"
                fill="#ffd65a" stroke="rgba(0,0,0,0.9)" stroke-width="10" stroke-linejoin="round"/>
          <path d="M0 -210 L70 -150 L170 -175 L145 -95 L230 -65 L150 0 L235 75 L145 95 L170 185 L70 155 L0 215 L-60 155 L-170 185 L-145 95 L-235 75 L-150 0 L-235 -65 L-145 -95 L-170 -175 L-60 -150 Z"
                fill="url(#dotBig)" opacity="0.65"/>
          <text x="0" y="18" text-anchor="middle" dominant-baseline="middle"
                font-family="Bazinga, Bangers, Impact, system-ui, sans-serif"
                font-size="140"
                fill="#ffffff"
                stroke="rgba(0,0,0,0.92)"
                stroke-width="18"
                paint-order="stroke"
                style="letter-spacing: 3px;"
          >${String(text||'').toUpperCase()}</text>
        </g>
      </svg>
    `;
  }

  function roundTransition(nextRoundNumber){
    roundOverlayText.innerHTML = roundBurstSVG(`ROUND ${nextRoundNumber}!`);
    roundOverlay.style.display = 'grid';

    // grow from vanishing point
    roundOverlayText.style.transformOrigin = '50% 50%';
    roundOverlayText.style.transform = 'scale(0.05)';
    roundOverlayText.style.opacity = '0.0';

    requestAnimationFrame(() => {
      roundOverlayText.style.transition = 'transform 520ms cubic-bezier(.2,.9,.2,1), opacity 240ms ease';
      roundOverlayText.style.transform = 'scale(1.0)';
      roundOverlayText.style.opacity = '1.0';
    });

    confettiBurst(3000);

    setTimeout(() => {
      roundOverlayText.style.transition = 'opacity 220ms ease';
      roundOverlayText.style.opacity = '0';
      setTimeout(() => {
        roundOverlay.style.display = 'none';
        renderFlag();
      }, 220);
    }, 1900);
  }

  /* =============================================================================================
     SECTION: GAME FLOW (UNCHANGED LOGIC; messages updated only via renderMsg)
     ============================================================================================= */

  function advanceFlag() {
    flagIdx++;
    if (flagIdx >= FLAGS_PER_ROUND) {
      roundIdx++;
      flagIdx = 0;

      if (roundIdx >= rounds.length) {
        renderMsg('success', `ğŸ Game complete! Final score: <b>${score}</b> ğŸ‰`, `Hit RESTART to play again.`);
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        guessInput.disabled = true;
        updateHUD();
        return;
      }

      updateHUD();
      roundTransition(roundIdx + 1);
      return;
    }

    renderFlag();
  }

  function consumeTryWithHint() {
    const c = currentCountry();
    if (!c) return;
    if (triesLeft <= 0) return;

    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;
    const hint = hintForTry(c, tryUsed);

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Out of tries! Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'hint',
      `Hint Used (costs a try!)`,
      `${hint}<br/><br/>You have <b>${triesLeft}</b> tries left.`
    );
  }

  function submitGuess() {
    const c = currentCountry();
    if (!c) return;

    applySuggestionSelectionToInput();

    const guess = guessInput.value;
    const guessN = norm(guess);
    const accepted = currentAcceptedNames(c);
    const tryUsed = TRIES_PER_FLAG - triesLeft + 1;

    if (guessN && accepted.has(guessN)) {
      const pts = pointsForTry(tryUsed);
      score += pts;
      updateHUD();

      const emoji = pick(["ğŸ‰","ğŸ¥³","âœ¨"]);
      renderMsg(
        'success',
        `Correct! That was <b>${c.name.common}</b>. ${emoji}`,
        `You earned <b>${pts}</b> point${pts === 1 ? '' : 's'}.<br/><br/>Next flag in <b>${Math.round(PAUSE_CORRECT_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_CORRECT_MS);
      return;
    }

    triesLeft--;
    updateHUD();

    if (triesLeft <= 0) {
      renderMsg(
        'fail',
        `Nope. Answer: <b>${c.name.common}</b>.`,
        `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
      );
      setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
      return;
    }

    renderMsg(
      'fail',
      `Not quite.`,
      `Try again. You have <b>${triesLeft}</b> tries left.`
    );

    guessInput.select();
    guessInput.focus();
  }

  function skipFlag() {
    const c = currentCountry();
    if (!c) return;

    renderMsg(
      'neutral',
      `Skipped. Answer: <b>${c.name.common}</b>.`,
      `${symbolismBlock(c)}<br/><br/>Next flag in <b>${Math.round(PAUSE_WRONG_MS/1000)}s</b>â€¦`
    );
    setTimeout(() => advanceFlag(), PAUSE_WRONG_MS);
  }

  function restart() {
    roundIdx = 0;
    flagIdx = 0;
    triesLeft = TRIES_PER_FLAG;
    score = 0;
    submitBtn.disabled = false;
    skipBtn.disabled = false;
    guessInput.disabled = false;
    renderFlag();
  }

  const WELL_KNOWN = new Set([
    'United States','Canada','Mexico','Brazil','Argentina','Chile','Colombia','Peru',
    'United Kingdom','Ireland','France','Spain','Portugal','Italy','Germany','Netherlands','Belgium','Switzerland','Austria','Sweden','Norway','Denmark','Finland','Iceland',
    'Russia','Ukraine','Poland','Czechia','Greece','Turkey',
    'China','Japan','South Korea','India','Pakistan','Bangladesh','Sri Lanka','Thailand','Vietnam','Indonesia','Philippines','Malaysia','Singapore',
    'Australia','New Zealand',
    'Egypt','South Africa','Nigeria','Kenya','Ethiopia','Ghana','Morocco','Tunisia',
    'Saudi Arabia','United Arab Emirates','Qatar','Iran','Iraq','Israel','Jordan','Lebanon','Syria'
  ]);

  function familiarityScore(c) {
    const pop = Math.max(0, c.population || 0);
    const popScore = Math.log10(pop + 1);
    const knownBoost = WELL_KNOWN.has(c.name.common) ? 6 : 0;
    return popScore + knownBoost;
  }

  function buildRoundsSmart(countries) {
    const scored = countries.map(c => ({ c, ease: familiarityScore(c) }));
    scored.sort((a,b) => b.ease - a.ease);

    const totalPossibleRounds = Math.floor(scored.length / FLAGS_PER_ROUND);
    const roundsCount = Math.max(6, Math.min(12, totalPossibleRounds));
    const bandSize = Math.floor(scored.length / roundsCount);

    const out = [];
    for (let r = 0; r < roundsCount; r++) {
      const start = r * bandSize;
      const end = (r === roundsCount - 1) ? scored.length : (r + 1) * bandSize;
      const band = scored.slice(start, end).map(x => x.c);
      shuffle(band);
      out.push(band.slice(0, FLAGS_PER_ROUND));
    }
    return out;
  }

  /* =============================================================================================
     SECTION: FLAG BANDS (HEADER + FOOTER)
     - 10% colored, washed out 50% (opacity 0.5).
     - Remaining 90%: grey outline â€œline-artâ€ derived from actual flag image via SVG filters.
     - Top-to-bottom draw order ensures correct occlusion.
     - Footer positioning logic unchanged; header is fixed height.
     ============================================================================================= */

  function _ensureFlagFilters(svgEl){
    const NS = 'http://www.w3.org/2000/svg';
    svgEl.innerHTML = '';

    const defs = document.createElementNS(NS,'defs');

    // Outline / line-art filter from the real flag image:
    // - grayscale -> edge detection -> threshold-ish -> tint to grey.
    const f = document.createElementNS(NS,'filter');
    f.setAttribute('id','flagOutline');
    f.setAttribute('x','-20%'); f.setAttribute('y','-20%');
    f.setAttribute('width','140%'); f.setAttribute('height','140%');

    const cm = document.createElementNS(NS,'feColorMatrix');
    cm.setAttribute('type','matrix');
    cm.setAttribute('values', `
      0.333 0.333 0.333 0 0
      0.333 0.333 0.333 0 0
      0.333 0.333 0.333 0 0
      0     0     0     1 0
    `.trim().replace(/\s+/g,' '));
    cm.setAttribute('result','gray');
    f.appendChild(cm);

    const conv = document.createElementNS(NS,'feConvolveMatrix');
    conv.setAttribute('in','gray');
    conv.setAttribute('order','3');
    conv.setAttribute('kernelMatrix','-1 -1 -1 -1 8 -1 -1 -1 -1');
    conv.setAttribute('result','edge');
    f.appendChild(conv);

    const comp = document.createElementNS(NS,'feComponentTransfer');
    comp.setAttribute('in','edge');
    const fnR = document.createElementNS(NS,'feFuncR'); fnR.setAttribute('type','gamma'); fnR.setAttribute('amplitude','1'); fnR.setAttribute('exponent','0.85'); fnR.setAttribute('offset','0');
    const fnG = document.createElementNS(NS,'feFuncG'); fnG.setAttribute('type','gamma'); fnG.setAttribute('amplitude','1'); fnG.setAttribute('exponent','0.85'); fnG.setAttribute('offset','0');
    const fnB = document.createElementNS(NS,'feFuncB'); fnB.setAttribute('type','gamma'); fnB.setAttribute('amplitude','1'); fnB.setAttribute('exponent','0.85'); fnB.setAttribute('offset','0');
    comp.appendChild(fnR); comp.appendChild(fnG); comp.appendChild(fnB);
    f.appendChild(comp);

    const tint = document.createElementNS(NS,'feColorMatrix');
    tint.setAttribute('type','matrix');
    tint.setAttribute('values', `
      0 0 0 0 0.20
      0 0 0 0 0.24
      0 0 0 0 0.30
      0 0 0 1 0
    `.trim().replace(/\s+/g,' '));
    tint.setAttribute('result','tint');
    f.appendChild(tint);

    defs.appendChild(f);

    // subtle shadow so overlaps read as â€œstackedâ€
    const sh = document.createElementNS(NS,'filter');
    sh.setAttribute('id','flagShadow');
    sh.setAttribute('x','-20%'); sh.setAttribute('y','-20%');
    sh.setAttribute('width','140%'); sh.setAttribute('height','140%');
    const ds = document.createElementNS(NS,'feDropShadow');
    ds.setAttribute('dx','0'); ds.setAttribute('dy','2'); ds.setAttribute('stdDeviation','1.4');
    ds.setAttribute('flood-color','rgba(0,0,0,0.22)');
    sh.appendChild(ds);
    defs.appendChild(sh);

    svgEl.appendChild(defs);
  }

  function _drawFlagBand(svgEl, bandH, mode){
    // mode: 'header' or 'footer' (affects â€œkeepStartâ€ / distribution; shapes identical)
    const NS = 'http://www.w3.org/2000/svg';
    _ensureFlagFilters(svgEl);

    const w = Math.max(1400, window.innerWidth);
    const h = Math.max(220, Math.round(bandH));

    svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);

    // Choose a pool of countries to sample flags from (more variety).
    const pool = countries.filter(c => c?.flags?.png).slice();
    shuffle(pool);

    // Placement tuned to preserve current â€œlookâ€ (do not change size/spacing elsewhere):
    const flagW = 64;
    const flagH = 36;

    const padX = 14;
    const padY = 10;

    const cellW = flagW * 1.20;
    const cellH = flagH * 1.18;

    const cols = Math.max(10, Math.floor((w - padX*2) / cellW));
    const rows = Math.max(4, Math.floor((h - padY*2) / cellH));

    const points = [];
    for (let r = 0; r < rows; r++){
      for (let c = 0; c < cols; c++){
        const xBase = padX + c * cellW;
        const yBase = padY + r * cellH;

        // Stronger scatter (avoid columns)
        const jx = (Math.random()*1.0 - 0.5) * (cellW * 0.85);
        const jy = (Math.random()*1.0 - 0.5) * (cellH * 0.75);

        points.push({ x: xBase + jx, y: yBase + jy });
      }
    }

    // Keep all points; order by y for occlusion
    points.sort((a,b)=> a.y - b.y);

    // For header: keep more near top; for footer: keep more near bottom.
    let keepStart = 0;
    if (mode === 'footer') keepStart = Math.floor(points.length * 0.18);
    if (mode === 'header') keepStart = Math.floor(points.length * 0.02);
    const keep = points.slice(keepStart);

    // 10% colored
    const coloredCount = Math.max(1, Math.floor(keep.length * 0.10));
    const coloredIdx = new Set();
    while (coloredIdx.size < coloredCount) coloredIdx.add(Math.floor(Math.random() * keep.length));

    // Draw top-to-bottom for occlusion (later = on top)
    const items = keep.map((p, i) => {
      const c = pool[i % pool.length];
      const rot = (Math.random() * 8 - 4);
      // IMPORTANT: rectangles only (no italics / skew); keep scale ~1
      const scale = 1.0;
      const isColored = coloredIdx.has(i);
      return { i, c, isColored, x: p.x, y: p.y, rot, scale };
    });

    items.sort((a,b)=> a.y - b.y);

    for (const it of items) {
      const g = document.createElementNS(NS,'g');
      g.setAttribute('transform', `translate(${it.x},${it.y}) rotate(${it.rot}) scale(${it.scale})`);
      g.setAttribute('filter', 'url(#flagShadow)');

      // clip to rounded-ish rect? keep square corners as requested
      const clipId = `clip_${mode}_${it.i}`;
      const defs = svgEl.querySelector('defs');
      const clip = document.createElementNS(NS,'clipPath');
      clip.setAttribute('id', clipId);
      const cr = document.createElementNS(NS,'rect');
      cr.setAttribute('x','0'); cr.setAttribute('y','0');
      cr.setAttribute('width', String(flagW));
      cr.setAttribute('height', String(flagH));
      cr.setAttribute('rx','0'); cr.setAttribute('ry','0');
      clip.appendChild(cr);
      defs.appendChild(clip);

      // base border (very light)
      const border = document.createElementNS(NS,'rect');
      border.setAttribute('x','0'); border.setAttribute('y','0');
      border.setAttribute('width', String(flagW));
      border.setAttribute('height', String(flagH));
      border.setAttribute('fill','rgba(255,255,255,0.85)');
      border.setAttribute('stroke','rgba(37,48,65,0.22)');
      border.setAttribute('stroke-width','1.0');
      g.appendChild(border);

      const img = document.createElementNS(NS,'image');
      img.setAttribute('href', it.c.flags.png);
      img.setAttribute('x','0');
      img.setAttribute('y','0');
      img.setAttribute('width', String(flagW));
      img.setAttribute('height', String(flagH));
      img.setAttribute('preserveAspectRatio','none');
      img.setAttribute('clip-path', `url(#${clipId})`);

      if (it.isColored) {
        // Colored flags: wash out 50%
        img.setAttribute('opacity','0.50');
      } else {
        // Line-art outline flags: derived from actual flag image with detail
        img.setAttribute('filter','url(#flagOutline)');
        img.setAttribute('opacity','0.38'); // slight fade but recognizable
      }

      g.appendChild(img);
      svgEl.appendChild(g);
    }
  }

  function buildFooter() {
    const footerEl = document.querySelector('.flagFooter');
    const msgRect = belowMsg.getBoundingClientRect();
    const pad = 10;

    const topPx = Math.min(
      Math.max(msgRect.bottom + pad, window.innerHeight * 0.64),
      window.innerHeight - 120
    );

    footerEl.style.top = `${Math.round(topPx)}px`;
    footerEl.style.height = `${Math.max(0, Math.round(window.innerHeight - topPx))}px`;

    const bandH = Math.max(220, Math.round(window.innerHeight - topPx));
    _drawFlagBand(footerSvg, bandH, 'footer');
  }

  function buildHeader() {
    const bandH = Math.max(175, Math.round(document.querySelector('.flagHeader').getBoundingClientRect().height));
    _drawFlagBand(headerSvg, bandH, 'header');
  }

  /* =============================================================================================
     SECTION: EVENTS (UNCHANGED)
     ============================================================================================= */

  submitBtn.addEventListener('click', submitGuess);
  skipBtn.addEventListener('click', skipFlag);
  restartBtnTop.addEventListener('click', () => { restart(); buildFooter(); buildHeader(); });

  guessInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
  guessInput.addEventListener('focus', () => { if (guessInput.value) renderSuggestions(guessInput.value); });

  document.addEventListener('mousedown', (e) => {
    const inWrap = e.target === guessInput || suggestBox.contains(e.target);
    if (!inWrap) closeSuggest();
  });

  guessInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(+1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }
    if (e.key === 'Escape') { closeSuggest(); return; }

    if (e.key === 'Enter') {
      e.preventDefault();
      if (suggestBox.style.display === 'block' && currentSuggestions.length) {
        applySuggestionSelectionToInput();
      }
      submitGuess();
      return;
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== '.') return;
    if (e.metaKey || e.ctrlKey || e.altKey) return;
    const t = e.target;
    const isTextField = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') && !t.readOnly && !t.disabled;
    if (isTextField) e.preventDefault();
    consumeTryWithHint();
    guessInput.focus();
  });

  /* =============================================================================================
     SECTION: BOOT / DATA LOAD (UNCHANGED)
     ============================================================================================= */

  async function loadCountries() {
    const res = await fetch(
      'https://restcountries.com/v3.1/all?fields=name,flags,altSpellings,population,region,subregion,cca3,borders'
    );
    if (!res.ok) throw new Error(`Failed to fetch countries: ${res.status}`);

    const data = await res.json();

    countries = data
      .filter(c => c?.name?.common && (c?.flags?.png || c?.flags?.svg))
      .map(c => ({
        name: c.name,
        altSpellings: c.altSpellings || [],
        flags: c.flags,
        population: c.population || 0,
        region: c.region || '',
        subregion: c.subregion || '',
        cca3: c.cca3 || '',
        borders: Array.isArray(c.borders) ? c.borders : []
      }));

    cca3ToCountry = new Map();
    for (const c of countries) {
      if (c.cca3) cca3ToCountry.set(c.cca3, c);
    }

    rounds = buildRoundsSmart(countries);
    buildHeader();
    buildFooter();
    restart();
  }

  loadCountries().catch(err => {
    console.error(err);
    renderMsg('fail', `Couldnâ€™t load country data.`, `${String(err.message || err)}`);
  });

  window.addEventListener('resize', () => { buildHeader(); buildFooter(); });
})();
</script>
</body>
</html>
